<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Task Manager TL</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800;900&family=Creepster&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            width: 100vw; 
            height: 100vh;
            overflow-x: hidden; 
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        .font-creepster { font-family: 'Creepster', cursive; }
        .font-christmas { font-family: 'Mountains of Christmas', cursive; }
    
        .app-container {
            min-height: 100vh;
            padding-top: max(1rem, env(safe-area-inset-top)); 
            padding-bottom: max(1rem, env(safe-area-inset-bottom)); 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hide-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; }
        .hide-scrollbar { scrollbar-width: none; }

        /* --- Animaci√≥n de Brillo (Glow) Halloween --- */
        @keyframes subtle-container-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 140, 0, 0.4), 0 0 5px rgba(128, 0, 128, 0.2); }
            50% { box-shadow: 0 0 25px rgba(255, 165, 0, 0.7), 0 0 10px rgba(255, 215, 0, 0.5); }
        }
        .glow-card {
            animation: subtle-container-glow 6s infinite ease-in-out alternate;
            position: relative; 
            overflow: hidden;
            border: 1px solid rgba(50, 50, 50, 0.5); 
        }

        /* --- Animaci√≥n de Brillo Festivo (Party Glow) --- */
        @keyframes party-container-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(217, 70, 239, 0.5), 0 0 8px rgba(34, 211, 238, 0.4); } /* Fucsia y Cian */
            50% { box-shadow: 0 0 30px rgba(244, 63, 94, 0.7), 0 0 15px rgba(6, 182, 212, 0.6); } /* Rosa y Cian brillante */
        }
        .party-glow-card {
            animation: party-container-glow 5s infinite ease-in-out alternate;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(120, 80, 150, 0.5);
        }
        
        /* --- Estilos de Part√≠culas (Niebla) --- */
        @keyframes particle-drift-and-fade {
            0% { transform: translate(0, 0) scale(0.8); opacity: 0; }
            25% { transform: translate(calc(var(--rand-x) * 0.25px), 25vh) scale(1); opacity: 0.5; }
            50% { transform: translate(calc(var(--rand-x) * 1.2px), 50vh) scale(1.1); opacity: 0.3; }
            75% { transform: translate(calc(var(--rand-x) * 0.5px), 75vh) scale(0.9); opacity: 0.1; }
            100% { transform: translate(calc(var(--rand-x) * 0.1px), 100vh) scale(0.5); opacity: 0; }
        }
        .particle {
            position: fixed; top: -10px; background-color: rgba(255, 165, 0, 0.4); 
            border-radius: 50%; box-shadow: 0 0 5px rgba(255, 165, 0, 0.6); 
            pointer-events: none; z-index: 1; 
        }
        .animate-particle { animation: particle-drift-and-fade var(--duration) linear infinite; }
        
        /* --- Estilos de Confeti (Fiesta) --- */
        @keyframes confetti-fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: fixed;
            top: 0;
            pointer-events: none;
            z-index: 1;
            animation: confetti-fall var(--duration) linear infinite;
            animation-delay: var(--delay);
        }

        /* --- Estilos de Telara√±a --- */
        .spider-web {
            position: absolute; top: 0; left: 0; width: 150px; height: 150px;
            pointer-events: none; z-index: 2; opacity: 0.5;
        }
        .spider-web:before, .spider-web:after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%; border: 2px solid rgba(150, 150, 150, 0.4); 
            box-sizing: border-box; mix-blend-mode: screen;
        }
        .spider-web:before {
            transform: rotate(45deg) scaleX(0.5) translate(-10%, 10%);
            border-radius: 0; border-top: none; border-right: none;
            clip-path: polygon(0 0, 100% 0, 100% 50%, 0% 100%);
        }
        .spider-web:after {
            transform: rotate(-45deg) scaleX(0.5) translate(-10%, -10%);
            border-radius: 0; border-top: none; border-left: none;
            clip-path: polygon(100% 0, 0 0, 0 50%, 100% 100%);
        }
        .spider-web .line1, .spider-web .line2 {
            content: ''; position: absolute; background: rgba(150, 150, 150, 0.4);
        }
        .spider-web .line1 { width: 120px; height: 2px; top: 0; left: 0; transform-origin: top left; transform: rotate(25deg); }
        .spider-web .line2 { width: 120px; height: 2px; top: 0; left: 0; transform-origin: top left; transform: rotate(-25deg); }

        /* --- Estilos de Nieve (Navidad) --- */
        @keyframes snowfall {
            0% { transform: translateY(-10vh) translateX(0); }
            100% { transform: translateY(110vh) translateX(calc(var(--drift) * 15vw)); }
        }
        .snowflake {
            position: fixed; top: 0; background: white; border-radius: 50%;
            pointer-events: none; z-index: 1; opacity: 0.8;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
            animation: snowfall var(--duration) linear infinite;
            animation-delay: var(--delay);
        }

        /* --- Estilos de Luces (Navidad) --- */
        @keyframes twinkle {
            0%, 100% { opacity: 0.6; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        .christmas-light {
            position: fixed; border-radius: 50%;
            animation: twinkle var(--duration) ease-in-out infinite alternate;
            z-index: 1; pointer-events: none;
        }

        /* --- Estilos de Fantasma (Halloween) --- */
        @keyframes float-ghost {
            0% { transform: translate(var(--start-x), 100vh) scale(1); opacity: 0; }
            20% { opacity: 0.6; }
            80% { opacity: 0.6; }
            100% { transform: translate(var(--end-x), -20vh) scale(1.1); opacity: 0; }
        }
        .ghost {
            position: fixed; bottom: -150px; z-index: 1;
            pointer-events: none;
            animation: float-ghost var(--duration) ease-in-out infinite;
            animation-delay: var(--delay);
            fill: rgba(255, 255, 255, 0.1);
            filter: drop-shadow(0 0 15px rgba(200, 220, 255, 0.6));
        }
        
        /* --- Estilos de Magia (Bianca Bday) --- */
        @keyframes magic-float {
            0% { transform: translateY(110vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
        }
        .magic-particle {
            position: fixed;
            top: 0;
            pointer-events: none;
            z-index: 1;
            animation: magic-float var(--duration) linear infinite;
            animation-delay: var(--delay);
        }
        
    </style>
</head>
<body class="bg-gray-900 transition-colors duration-500">

    <div id="root" class="app-container"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- SECTION: CONSTANTS AND CONFIGURATION ---
        const birthdaysList = [
            { name: "Seba y Estefania", date: "12-08" },
            { name: "Bianca", date: "12-18" },
            { name: "Mica", date: "08-01" },
            { name: "Arturo", date: "04-01" },
            { name: "Mica", date: "11-21" },
            { name: "Angie", date: "11-19" }, 
            { name: "Dana", date: "08-28" },
            { name: "Iliana", date: "12-27" },
            { name: "Valentina", date: "09-03" },
        ];
        
        const themes = {
            default: { bodyBg: 'bg-gray-900', cardBg: 'bg-gray-800', itemBg: 'bg-gray-700', primaryText: 'text-white', secondaryText: 'text-gray-300', accentText: 'text-yellow-300', buttonAdd: 'bg-blue-600 hover:bg-blue-700', buttonAction: 'bg-purple-600 hover:bg-purple-700', inputBorder: 'border-gray-600 focus:ring-blue-500', shopSelectBorder: 'border-yellow-600 focus:ring-yellow-500', titleFont: '' },
            halloween: { bodyBg: 'bg-gray-950', cardBg: 'bg-[#0a0a0a] shadow-2xl', itemBg: 'bg-gray-800/40 border border-gray-700/60', primaryText: 'text-orange-500', secondaryText: 'text-gray-300', accentText: 'text-yellow-400', buttonAdd: 'bg-orange-600 hover:bg-orange-700 text-white', buttonAction: 'bg-purple-700 hover:bg-purple-800 text-white', inputBorder: 'border-gray-700 focus:ring-orange-500', shopSelectBorder: 'border-orange-500 focus:ring-orange-400', titleFont: 'font-creepster tracking-widest' },
            christmas: { bodyBg: 'bg-red-900', cardBg: 'bg-green-900/90 backdrop-blur-sm', itemBg: 'bg-green-800/50 border border-yellow-300/30', primaryText: 'text-white', secondaryText: 'text-gray-200', accentText: 'text-yellow-300', buttonAdd: 'bg-red-600 hover:bg-red-700 text-white', buttonAction: 'bg-yellow-500 hover:bg-yellow-600 text-green-900', inputBorder: 'border-red-400 focus:ring-red-300', shopSelectBorder: 'border-yellow-400 focus:ring-yellow-300', titleFont: 'font-christmas' },
            party: { bodyBg: 'bg-black', cardBg: 'bg-gray-900/80 backdrop-blur-sm', itemBg: 'bg-gray-800/50 border border-purple-500/30', primaryText: 'text-fuchsia-400', secondaryText: 'text-gray-200', accentText: 'text-cyan-400', buttonAdd: 'bg-fuchsia-600 hover:bg-fuchsia-700 text-white', buttonAction: 'bg-cyan-500 hover:bg-cyan-600 text-white', inputBorder: 'border-gray-600 focus:ring-fuchsia-500', shopSelectBorder: 'border-cyan-500 focus:ring-cyan-400', titleFont: 'font-bold' },
            biancaBday: { bodyBg: 'bg-black', cardBg: 'bg-gray-950/90 backdrop-blur-sm shadow-2xl shadow-purple-500/30', itemBg: 'bg-gray-800/60 border border-purple-700/50', primaryText: 'text-purple-400', secondaryText: 'text-red-400', accentText: 'text-pink-400', buttonAdd: 'bg-red-600 hover:bg-red-700 text-white', buttonAction: 'bg-purple-600 hover:bg-purple-700 text-white', inputBorder: 'border-gray-700 focus:ring-purple-500', shopSelectBorder: 'border-pink-400 focus:ring-pink-400', titleFont: 'font-christmas' }
        };

        const shopOptions = ["Tienda Lujosa", "Clara Tienda", "Clara Tierra"];
        const CLARA_TIENDA_TASK_NAME = "√ìrdenes / Tarea √önica";
        const taskOptions = ["Columna CONFIRMADO", "Columna POR UPSELL", "Columna DATOS ENTREGA", "Columna RESPONDER", "Columna FALLIDO", "Columna REMINDER", "Columna PENDIENTE", "Chat en vivo (filtro Abiertos)", "Chat en vivo (filtro Pendiente)", "Ordenes confirmadas sheet (CHECK info)", "CHAT Pending Orders", "CALL Pending Orders", "Facebook/Instagram Comments & Chats", "Meeting"];
        
        // --- SECTION: UTILITY FUNCTIONS ---
        const formatTime = (ms) => {
            if (ms < 0) return '00:00:00';
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        };

        const generateEODRContent = (tasks) => {
            let totalMilliseconds = 0;
            const tasksByShop = tasks.reduce((acc, task) => {
                const finalTime = task.running ? task.elapsedTime + (Date.now() - (task.lastTime || Date.now())) : task.elapsedTime;
                const shopName = task.shop || 'Sin Tienda';
                if (!acc[shopName]) acc[shopName] = [];
                acc[shopName].push({ ...task, finalTime });
                totalMilliseconds += finalTime;
                return acc;
            }, {});

            let formattedReport = [];
            Object.keys(tasksByShop).sort().forEach(shopName => {
                formattedReport.push(`--- ${shopName} ---`);
                tasksByShop[shopName].forEach(task => {
                    const totalSeconds = Math.floor(task.finalTime / 1000);
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const timeString = `${hours}h ${minutes}m`;
                    const quantityText = task.quantity ? ` (${task.quantity} orders)` : '';
                    const reportTaskName = task.rawTaskName || task.name.replace(` [${shopName}]`, '');
                    formattedReport.push(`${reportTaskName}${quantityText}: ${timeString}`);
                });
            });

            const totalSeconds = Math.floor(totalMilliseconds / 1000);
            const totalHours = Math.floor(totalSeconds / 3600);
            const totalMinutes = Math.floor((totalSeconds % 3600) / 60);
            const totalTimeString = `${totalHours}h ${totalMinutes}m`;
            const currentDate = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            return `End of Day Report: ${currentDate}\nHours worked: ${totalTimeString}\n\nToday I worked on the following tasks:\n${formattedReport.join('\n')}`;
        };

        // --- SECTION: CUSTOM HOOKS ---
        const usePersistentState = (key, initialValue) => {
            const [state, setState] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) { console.error("Error reading from localStorage", error); return initialValue; }
            });
            useEffect(() => {
                try { window.localStorage.setItem(key, JSON.stringify(state)); } catch (error) { console.error("Error writing to localStorage", error); }
            }, [key, state]);
            return [state, setState];
        };

        const useCelebration = (birthdays) => {
            const checkBirthday = useCallback((birthdays) => {
                const today = new Date();
                
                // --- FECHA REAL (ACTIVADA) ---
                const todayFormatted = `${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                
                // --- DEBUG / TEST MODE: FORZANDO EL 19 DE NOVIEMBRE (11-19) PARA LA DEMOSTRACI√ìN ---
                // const todayFormatted = "11-19"; // <-- L√≠nea de testeo comentada
                
                const found = birthdays.find(b => b.date === todayFormatted);
                return found ? found.name : null;
            }, []);

            const celebration = useMemo(() => {
                const today = new Date();
                const month = today.getMonth() + 1;
                
                const birthdayPerson = checkBirthday(birthdays);

                // --- L√≥gica de Cumplea√±os (Prioridad 1) ---
                if (birthdayPerson) {
                    if (birthdayPerson === "Bianca") {
                        return { theme: 'biancaBday', message: `¬°Feliz Cumplea√±os Bianca! ü¶Ñüê±`, icon: 'bianca' };
                    }
                    return { theme: 'party', message: `¬°Feliz Cumplea√±os ${birthdayPerson}! üéâ`, icon: 'party' };
                }

                // --- L√≥gica Estacional (Si no hay cumplea√±os) ---
                if (month === 10) return { theme: 'halloween', message: '¬°Feliz Halloween!', icon: 'halloween' };
                if (month === 12) return { theme: 'christmas', message: '¬°Feliz Navidad!', icon: 'christmas' };
                
                return { theme: 'default', message: '', icon: 'default' };
            }, [birthdays, checkBirthday]);
            
            const themeClasses = useMemo(() => themes[celebration.theme] || themes.default, [celebration.theme]);
            return { celebration, themeClasses };
        };

        const useTasks = () => {
            const [tasks, setTasks] = usePersistentState('tasks', []);
            const [errorMessage, setErrorMessage] = useState('');
            // Nuevo estado para el mensaje de status global (incluyendo el ID para reanudar)
            const [statusMessage, setStatusMessage] = useState(null); // { text: string, taskIdToResume: number | null }

            useEffect(() => {
                const interval = setInterval(() => {
                    setTasks(currentTasks => currentTasks.map(t => t.running ? { ...t, elapsedTime: t.elapsedTime + (Date.now() - t.lastTime), lastTime: Date.now() } : t));
                }, 1000);
                return () => clearInterval(interval);
            }, [setTasks]);
            
            const addTask = useCallback((taskData) => {
                const { shopInput, taskName, orderQuantity } = taskData;
                if (!shopInput || !taskName) { setErrorMessage('Completa todos los campos.'); return false; }
                const fullTaskName = `${taskName} [${shopInput}]`;
                if (tasks.some(t => t.name.toLowerCase() === fullTaskName.toLowerCase())) { setErrorMessage(`La tarea "${fullTaskName}" ya existe.`); return false; }
                const isCustom = !taskOptions.includes(taskName);
                const newTask = { id: Date.now(), name: fullTaskName, rawTaskName: taskName, shop: shopInput, quantity: orderQuantity ? parseInt(orderQuantity) : null, elapsedTime: 0, running: false, lastTime: null, isCustom };
                setTasks(prev => [...prev, newTask]);
                setErrorMessage('');
                return true;
            }, [tasks, setTasks]);
            
            const deleteTask = useCallback((id) => setTasks(prev => prev.filter(t => t.id !== id)), [setTasks]);
            
            // Funci√≥n mejorada para detener y actualizar una tarea espec√≠fica
            const toggleTimer = useCallback((id) => {
                setTasks(prev => {
                    const now = Date.now();
                    return prev.map(t => {
                        // Detener cualquier otra tarea en ejecuci√≥n
                        if (t.running && t.id !== id) return { ...t, running: false, elapsedTime: t.elapsedTime + (now - t.lastTime), lastTime: null };
                        
                        // Iniciar/Detener la tarea actual
                        if (t.id === id) {
                            const newRunning = !t.running;
                            return { ...t, running: newRunning, elapsedTime: newRunning ? t.elapsedTime : (t.elapsedTime + (now - t.lastTime)), lastTime: newRunning ? now : null };
                        }
                        return t;
                    });
                });
            }, [setTasks]);

            // NUEVA FUNCI√ìN: Detener todas las tareas
            const stopAllTimers = useCallback(() => {
                let tasksStopped = false;
                let lastRunningTaskId = null;
                const now = Date.now();
                
                setTasks(prev => {
                    const newTasks = prev.map(t => {
                        if (t.running) {
                            tasksStopped = true;
                            lastRunningTaskId = t.id; // Store ID of the one that was running
                            return { ...t, running: false, elapsedTime: t.elapsedTime + (now - t.lastTime), lastTime: null };
                        }
                        return t;
                    });
                    
                    if (!tasksStopped) {
                        setStatusMessage({ text: 'No hay tareas activas para detener.', taskIdToResume: null });
                        return prev;
                    }
                    
                    // Set the message and the task ID to resume
                    setStatusMessage({ 
                        text: `Todas las tareas han sido detenidas. (√öltima: ${newTasks.find(t => t.id === lastRunningTaskId)?.rawTaskName || 'N/A'})`, 
                        taskIdToResume: lastRunningTaskId 
                    });
                    return newTasks;
                });
            }, [setTasks]);

            // NUEVA FUNCI√ìN: Reanudar la tarea que fue detenida
            const resumeStoppedTimers = useCallback(() => {
                if (!statusMessage || statusMessage.taskIdToResume === null) return;
                
                // Intentar reanudar la tarea
                const idToResume = statusMessage.taskIdToResume;
                
                // Importante: Llama a toggleTimer, que se encarga de detener cualquier otra cosa
                // (aunque no deber√≠a haber nada corriendo despu√©s de stopAllTimers)
                toggleTimer(idToResume); 
                
                // Limpiar el mensaje despu√©s de reanudar
                setStatusMessage(null);
            }, [statusMessage, toggleTimer]);

            // Funci√≥n para limpiar el mensaje de status manualmente o por timeout
            const clearStatusMessage = useCallback(() => {
                setStatusMessage(null);
            }, []);
            
            // Funci√≥n de Reset: Reinicia tiempo y cantidad.
            const resetTaskTimer = useCallback((id) => {
                setTasks(prev => prev.map(t => 
                    t.id === id 
                    ? { ...t, elapsedTime: 0, running: false, lastTime: null, quantity: null } 
                    : t
                ));
            }, [setTasks]);
            
            const updateTaskDetails = useCallback((id, newDetails) => {
                setTasks(prev => prev.map(t => {
                    if (t.id === id) {
                        // Permite editar todos los detalles de la tarea, incluyendo el nombre completo.
                        const newRawTaskName = newDetails.rawTaskName !== undefined ? newDetails.rawTaskName : t.rawTaskName;
                        const newShop = newDetails.shop !== undefined ? newDetails.shop : t.shop;
                        const newFullName = newRawTaskName ? `${newRawTaskName} [${newShop}]` : t.name;

                        // Validaci√≥n de duplicados
                        if (prev.some(et => et.id !== id && et.name.toLowerCase() === newFullName.toLowerCase())) { 
                            setErrorMessage('Esa Tarea+Tienda ya existe.'); 
                            return t; 
                        }
                        setErrorMessage('');
                        return { ...t, ...newDetails, rawTaskName: newRawTaskName, shop: newShop, name: newFullName };
                    }
                    return t;
                }));
            }, [setTasks]);

            const sortTasksByShop = useCallback(() => setTasks(prev => [...prev].sort((a, b) => a.shop.localeCompare(b.shop))), [setTasks]);
            
            return { tasks, errorMessage, setErrorMessage, addTask, deleteTask, toggleTimer, updateTaskDetails, sortTasksByShop, resetTaskTimer, stopAllTimers, statusMessage, resumeStoppedTimers, clearStatusMessage };
        };

        // --- SECTION: UI COMPONENTS ---

        const BackgroundParticles = ({ isHalloween }) => {
            if (!isHalloween) return null;
            const particles = useMemo(() => Array.from({ length: 80 }).map((_, i) => ({ key: i, left: `${Math.random() * 100}vw`, size: `${2 + Math.random() * 5}px`, duration: `${20 + Math.random() * 20}s`, delay: `${Math.random() * 15}s`, randX: `${(Math.random() - 0.5) * 350}` })), []);
            return (<div className="w-full h-full absolute top-0 left-0">{particles.map(p => <div key={p.key} className="particle animate-particle" style={{ left: p.left, width: p.size, height: p.size, '--duration': p.duration, '--rand-x': p.randX, animationDelay: p.delay }} />)}</div>);
        };
        
        const BackgroundConfetti = ({ isParty }) => {
            if (!isParty) return null;
            const confettiPieces = useMemo(() => {
                const colors = ['#f43f5e', '#ec4899', '#8b5cf6', '#38bdf8'];
                return Array.from({ length: 100 }).map((_, i) => {
                    const size = Math.random() * 8 + 4; const isSquare = Math.random() > 0.5;
                    return { key: i, left: `${Math.random() * 100}vw`, width: `${size}px`, height: `${size}px`, backgroundColor: colors[Math.floor(Math.random() * colors.length)], borderRadius: isSquare ? '2px' : '50%', transform: `rotate(${Math.random() * 360}deg)`, '--duration': `${Math.random() * 5 + 5}s`, '--delay': `${Math.random() * 5}s` };
                });
            }, []);
            return (<div className="w-full h-full absolute top-0 left-0 overflow-hidden">{confettiPieces.map(style => <div key={style.key} className="confetti" style={style} />)}</div>);
        };

        const BackgroundSnow = ({ isChristmas }) => {
            if (!isChristmas) return null;
            const snowflakes = useMemo(() => Array.from({ length: 150 }).map((_, i) => {
                const size = Math.random() * 4 + 2;
                return { key: i, left: `${Math.random() * 100}vw`, width: `${size}px`, height: `${size}px`, '--duration': `${Math.random() * 10 + 10}s`, '--delay': `${Math.random() * 10}s`, '--drift': Math.random() - 0.5 };
            }), []);
            return (<div className="w-full h-full absolute top-0 left-0 overflow-hidden">{snowflakes.map(style => <div key={style.key} className="snowflake" style={style} />)}</div>);
        };

        const BackgroundChristmasLights = ({ isChristmas }) => {
            if (!isChristmas) return null;
            const lights = useMemo(() => {
                const colors = ['#f44336', '#4caf50', '#2196f3', '#ffeb3b'];
                return Array.from({ length: 40 }).map((_, i) => {
                    const size = Math.random() * 10 + 5;
                    return { key: i, top: `${Math.random() * 100}vh`, left: `${Math.random() * 100}vw`, width: `${size}px`, height: `${size}px`, backgroundColor: colors[i % colors.length], boxShadow: `0 0 15px 5px ${colors[i % colors.length]}66`, '--duration': `${Math.random() * 2 + 1.5}s`, animationDelay: `${Math.random() * 2}s` };
                });
            }, []);
            return (<div className="w-full h-full absolute top-0 left-0">{lights.map(style => <div key={style.key} className="christmas-light" style={style} />)}</div>);
        };
        
        const BackgroundGhost = ({ isHalloween }) => {
            if (!isHalloween) return null;
            const ghosts = useMemo(() => Array.from({ length: 5 }).map((_, i) => ({ key: i, '--duration': `${Math.random() * 15 + 10}s`, '--delay': `${Math.random() * 10}s`, '--start-x': `${Math.random() * 80 + 10}vw`, '--end-x': `${Math.random() * 80 + 10}vw`, width: `${Math.random() * 50 + 50}px` })), []);
            return (<div className="w-full h-full absolute top-0 left-0 overflow-hidden">{ghosts.map(style => (<svg key={style.key} className="ghost" style={style} viewBox="0 0 100 125"><path d="M10 115 C 10 115, 10 95, 20 95 C 30 95, 30 115, 30 115 C 30 115, 30 95, 40 95 C 50 95, 50 115, 50 115 C 50 115, 50 95, 60 95 C 70 95, 70 115, 70 115 C 70 115, 70 95, 80 95 C 90 95, 90 115, 90 115 L 90 60 C 90 20, 50 10, 50 10 C 50 10, 10 20, 10 60 Z M 30 60 C 35 60, 35 50, 30 50 C 25 50, 25 60, 30 60 Z M 70 60 C 75 60, 75 50, 70 50 C 65 50, 65 60, 70 60 Z" /></svg>))}</div>);
        };
        
        const BackgroundMagic = ({ isBiancaBday }) => {
            if (!isBiancaBday) return null;
            const particles = useMemo(() => {
                const emojis = ['ü¶Ñ', 'üê±', '‚ú®', 'üíú', '‚ù§Ô∏è', 'üíñ'];
                return Array.from({ length: 100 }).map((_, i) => {
                    return { 
                        key: i, 
                        left: `${Math.random() * 100}vw`, 
                        fontSize: `${Math.random() * 1.5 + 0.75}rem`,
                        opacity: Math.random() * 0.5 + 0.5,
                        emoji: emojis[i % emojis.length],
                        '--duration': `${Math.random() * 10 + 8}s`, 
                        '--delay': `${Math.random() * 8}s` 
                    };
                });
            }, []);
            return (<div className="w-full h-full absolute top-0 left-0 overflow-hidden">{particles.map(style => <div key={style.key} className="magic-particle" style={style}>{style.emoji}</div>)}</div>);
        };
        
        const SpiderWeb = ({ isHalloween }) => {
            if (!isHalloween) return null;
            return (
                <>
                    <div className="spider-web"><div className="line1"></div><div className="line2"></div></div>
                    <div className="spider-web" style={{ left: 'auto', right: 0, transform: 'scaleX(-1)' }}><div className="line1"></div><div className="line2"></div></div>
                </>
            );
        };

        const Title = ({ themeClasses, celebration }) => { 
            const shadowStyle = celebration.theme === 'halloween' ? '[text-shadow:0_0_8px_rgba(255,165,0,0.6)]' : celebration.theme === 'party' ? '[text-shadow:0_0_10px_rgba(217,70,239,0.7)]' : celebration.theme === 'biancaBday' ? '[text-shadow:0_0_12px_rgba(236,72,153,0.6)]' : '';
            
            const renderIcon = (icon) => {
                switch (icon) {
                    case 'halloween': return (<><span className="inline-block transform -rotate-12 scale-110 mr-2">üëª</span>Task Manager TL<span className="inline-block transform rotate-12 scale-110 ml-2">üéÉ</span></>);
                    case 'christmas': return (<><span className="inline-block transform -rotate-12 scale-110 mr-2 text-3xl">üéÖ</span>Task Manager TL<span className="inline-block transform rotate-12 scale-110 ml-2 text-3xl">üéÑ</span></>);
                    case 'party': return (<><span className="inline-block transform -rotate-12 scale-110 mr-2 text-3xl">üéâ</span>Task Manager TL<span className="inline-block transform rotate-12 scale-110 ml-2 text-3xl">üéÇ</span></>);
                    case 'bianca': return (<><span className="inline-block transform -rotate-12 scale-110 mr-2 text-3xl">ü¶Ñ</span>Task Manager TL<span className="inline-block transform rotate-12 scale-110 ml-2 text-3xl">üê±</span></>);
                    default: return 'Task Manager TL';
                }
            };
            
            return (
                <div className="text-center mb-4"><h1 className={`text-4xl font-extrabold transition-colors duration-500 ${themeClasses.primaryText} ${themeClasses.titleFont} ${shadowStyle}`}>{renderIcon(celebration.icon)}</h1>{celebration.message && <p className={`mt-2 text-lg font-semibold animate-pulse ${themeClasses.accentText}`}>{celebration.message}</p>}</div>
            );
        };
        
        const TaskListItem = ({ task, toggleTimer, deleteTask, updateTaskDetails, themeClasses, resetTaskTimer, celebrationTheme }) => {
            const [isEditingTime, setIsEditingTime] = useState(false); 
            const [editedTime, setEditedTime] = useState(formatTime(task.elapsedTime)); 
            const [isEditingQuantity, setIsEditingQuantity] = useState(false); 
            const [editedQuantity, setEditedQuantity] = useState(task.quantity || ''); 
            const [isEditingShop, setIsEditingShop] = useState(false); 
            const [editedShop, setEditedShop] = useState(task.shop); 
            const [isEditingName, setIsEditingName] = useState(false); 
            const [editedName, setEditedName] = useState(task.rawTaskName);
            const [isConfirmingReset, setIsConfirmingReset] = useState(false);
            
            const currentElapsedTime = task.running ? task.elapsedTime + (Date.now() - (task.lastTime || Date.now())) : task.elapsedTime; 
            const isClaraTiendaFixedTask = task.rawTaskName === CLARA_TIENDA_TASK_NAME;
            const isCustomTask = task.isCustom; // Usar la nueva propiedad para determinar si es editable
            
            const handleTimeEdit = () => { 
                const parts = editedTime.split(':').map(Number); 
                if (parts.length === 3 && !parts.some(isNaN)) { 
                    const totalMs = (parts[0] * 3600 + parts[1] * 60 + parts[2]) * 1000; 
                    updateTaskDetails(task.id, { elapsedTime: totalMs }); 
                } 
                setIsEditingTime(false); 
            };

            const handleQuantityEdit = () => { 
                updateTaskDetails(task.id, { quantity: parseInt(editedQuantity) || null }); 
                setIsEditingQuantity(false); 
            };

            const handleShopEdit = () => { 
                if (editedShop) updateTaskDetails(task.id, { shop: editedShop }); 
                setIsEditingShop(false); 
            };

            const handleNameEdit = () => {
                const nameToUpdate = editedName.trim() || 'Tarea sin Nombre';
                updateTaskDetails(task.id, { rawTaskName: nameToUpdate }); 
                setIsEditingName(false);
            };
            
            const handleResetClick = () => {
                resetTaskTimer(task.id);
                setIsConfirmingReset(false);
            };

            const runningBorderClass = task.running 
                ? (celebrationTheme === 'biancaBday' ? 'border-l-4 border-pink-400' : 'border-l-4 border-green-500') 
                : 'border-l-4 border-gray-600';

            const buttonIncrementClass = task.running ? 'bg-green-600 hover:bg-green-700' : themeClasses.buttonAdd.replace('w-full sm:w-auto', '').replace('py-3', 'py-1').replace('px-6', 'px-2');

            // Clase para el nombre de la tarea (editable si es personalizada)
            const taskNameClass = isCustomTask ? 'cursor-pointer hover:opacity-80' : 'cursor-default';


            return (
                <div className={`flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 p-4 rounded-xl shadow-md ${themeClasses.itemBg} ${runningBorderClass}`}>
                    
                    {/* Details Section */}
                    <div className="flex flex-col gap-1 min-w-0 flex-grow">
                        {isEditingShop ? (
                            <select 
                                value={editedShop} 
                                onChange={(e) => setEditedShop(e.target.value)} 
                                onBlur={handleShopEdit} 
                                onKeyPress={(e) => e.key === 'Enter' && handleShopEdit()} 
                                className={`px-2 py-1 border-b-2 bg-transparent focus:outline-none w-full sm:w-32 rounded ${themeClasses.accentText} border-pink-500`} 
                                autoFocus
                            >
                                {shopOptions.map(o => <option key={o} value={o}>{o}</option>)}
                            </select>
                        ) : (
                            <span 
                                className={`font-bold text-sm transition-colors ${themeClasses.accentText} cursor-pointer hover:opacity-80`} 
                                onClick={() => {
                                    setEditedShop(task.shop); // Sincronizar estado antes de editar
                                    setIsEditingShop(true);
                                }}
                            >
                                {task.shop || 'Sin Tienda'}
                            </span>
                        )}

                        {isEditingName && isCustomTask ? (
                            <input
                                type="text"
                                value={editedName}
                                onChange={(e) => setEditedName(e.target.value)}
                                onBlur={handleNameEdit}
                                onKeyPress={(e) => e.key === 'Enter' && handleNameEdit()}
                                className={`font-medium text-lg border-b-2 bg-transparent focus:outline-none w-full ${themeClasses.secondaryText} border-pink-500`}
                                autoFocus
                            />
                        ) : (
                            <span 
                                className={`font-medium text-lg break-words ${taskNameClass} ${themeClasses.secondaryText}`}
                                onClick={() => {
                                    if (isCustomTask) {
                                        setEditedName(task.rawTaskName); // Sincronizar estado antes de editar
                                        setIsEditingName(true);
                                    }
                                }} 
                            >
                                {task.rawTaskName || task.name}
                            </span>
                        )}
                        
                        {/* Contador + Bot√≥n de Incremento R√°pido */}
                        {isEditingQuantity ? (
                            <input 
                                type="number" 
                                value={editedQuantity} 
                                onChange={(e) => setEditedQuantity(e.target.value)} 
                                onBlur={handleQuantityEdit} 
                                onKeyPress={(e) => e.key === 'Enter' && handleQuantityEdit()} 
                                className={`font-mono text-lg border-b-2 bg-transparent focus:outline-none w-full sm:w-24 ${themeClasses.secondaryText} border-blue-500`} 
                                autoFocus 
                            />
                        ) : (
                            <div className="flex items-center gap-2">
                                <span 
                                    className={`font-mono text-base cursor-pointer hover:opacity-80 transition-colors ${themeClasses.secondaryText}`} 
                                    onClick={() => {
                                        setEditedQuantity(task.quantity || ''); // Sincronizar estado antes de editar
                                        setIsEditingQuantity(true);
                                    }}
                                >
                                    {task.quantity ? `${task.quantity} √≥rdenes` : '(sin cantidad)'}
                                </span>
                                <button 
                                    onClick={() => updateTaskDetails(task.id, { quantity: (task.quantity || 0) + 1 })}
                                    className={`text-xs px-3 py-1 rounded-full text-white font-bold transition duration-200 shadow-md ${buttonIncrementClass} hover:scale-105`}
                                    title="A√±adir 1 Orden"
                                >
                                    +1
                                </button>
                            </div>
                        )}
                    </div>

                    {/* --- ACTIONS SECTION --- */}
                    <div className="flex items-center justify-between sm:justify-end gap-3 w-full sm:w-auto flex-shrink-0 pt-4 sm:pt-0 mt-4 sm:mt-0 border-t border-gray-700/60 sm:border-none">
                        {isEditingTime ? (
                            <input type="text" value={editedTime} onChange={(e) => setEditedTime(e.target.value)} onBlur={handleTimeEdit} onKeyPress={(e) => e.key === 'Enter' && handleTimeEdit()} placeholder="HH:MM:SS" className={`font-mono text-xl border-b-2 bg-transparent focus:outline-none w-28 ${themeClasses.primaryText} border-blue-500`} autoFocus />
                        ) : (
                            <span 
                                className={`font-mono text-xl cursor-pointer hover:opacity-80 transition-colors ${themeClasses.primaryText}`} 
                                onClick={() => { 
                                    setEditedTime(formatTime(currentElapsedTime)); // Sincronizar tiempo antes de editar
                                    setIsEditingTime(true); 
                                }}
                            >
                                {formatTime(currentElapsedTime)}
                            </span>
                        )}

                        {/* --- GRUPO DE BOTONES --- */}
                        <div className="flex flex-col sm:flex-row sm:items-center items-end gap-2 flex-grow sm:flex-grow-0">
                            {/* Bot√≥n Principal (Iniciar/Detener) */}
                            <button 
                                onClick={() => toggleTimer(task.id)} 
                                className={`px-4 py-2 rounded-full text-white font-semibold transition duration-300 shadow-md ${task.running ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} w-full sm:w-auto`}
                            >
                                {task.running ? 'Detener' : 'Iniciar'}
                            </button>
                           
                           {/* Botones Secundarios (Reset/Delete) */}
                           <div className="flex items-center justify-end gap-2">
                               {isConfirmingReset ? (
                                    <>
                                        <button 
                                            onClick={handleResetClick}
                                            className="p-2 text-white bg-red-600 rounded-full hover:bg-red-700 transition duration-300"
                                            title="Confirmar Reinicio y Cantidad"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                            </svg>
                                        </button>
                                        <button 
                                            onClick={() => setIsConfirmingReset(false)}
                                            className="p-2 text-gray-400 hover:text-white transition duration-300"
                                            title="Cancelar"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                                            </svg>
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <button 
                                            onClick={() => setIsConfirmingReset(true)} 
                                            className="p-2 text-gray-400 hover:text-pink-500 transition duration-300"
                                            title="Reiniciar Cron√≥metro y Cantidad"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2A8.001 8.001 0 0019.418 15m0 0H15" />
                                            </svg>
                                        </button>
                                    </>
                                )}
                               
                               <button onClick={() => deleteTask(task.id)} className="p-2 text-gray-400 hover:text-red-500 transition duration-300"><svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg></button>
                           </div>
                        </div>
                    </div>
                </div>
            );
        };

        const GlobalStatusMessage = ({ message, resumeAction, dismissAction }) => {
            if (!message) return null;
            
            const isSuccess = message.taskIdToResume !== null;
            const bgColor = isSuccess ? 'bg-green-700/80' : 'bg-yellow-700/80';
            const borderColor = isSuccess ? 'border-green-400' : 'border-yellow-400';
            
            return (
                <div className={`fixed top-0 left-0 w-full p-4 z-50 backdrop-blur-sm transition-all duration-300 transform translate-y-0`}>
                    <div className={`max-w-xl mx-auto p-4 rounded-xl shadow-2xl flex flex-col sm:flex-row items-center justify-between gap-3 ${bgColor} border ${borderColor} text-white`}>
                        <p className="font-semibold text-center sm:text-left flex-grow">{message.text}</p>
                        <div className="flex gap-3 flex-shrink-0">
                            {message.taskIdToResume !== null && (
                                <button 
                                    onClick={resumeAction}
                                    className={`px-4 py-2 text-sm font-bold rounded-full bg-blue-500 hover:bg-blue-600 transition duration-200 shadow-md`}
                                >
                                    Reanudar Tarea
                                </button>
                            )}
                            <button 
                                onClick={dismissAction}
                                className="px-4 py-2 text-sm font-bold rounded-full bg-gray-600 hover:bg-gray-700 transition duration-200"
                            >
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const TaskInputForm = ({ addTask, errorMessage, setErrorMessage, themeClasses }) => {
            const [shopInput, setShopInput] = useState(''); 
            const [taskInput, setTaskInput] = useState(''); 
            const [customTaskName, setCustomTaskName] = useState(''); 
            const [orderQuantity, setOrderQuantity] = useState(''); 
            const [isCustomTask, setIsCustomTask] = useState(false); 

            const handleShopChange = (e) => { 
                const newShop = e.target.value; 
                setShopInput(newShop); 
            };

            const handleTaskChange = (e) => { 
                const value = e.target.value; 
                setTaskInput(value); 
                // Actualizar isCustomTask basado en si seleccion√≥ la opci√≥n "Otra"
                setIsCustomTask(value === "OTHER_CUSTOM_TASK"); 
                if (value !== "OTHER_CUSTOM_TASK") setCustomTaskName(''); 
            };
            
            const handleSubmit = (e) => { 
                e.preventDefault(); 
                const finalTaskName = isCustomTask ? customTaskName.trim() : taskInput.trim(); 
                
                if (!shopInput || !finalTaskName) { 
                    setErrorMessage('Aseg√∫rate de seleccionar una tienda y especificar una tarea.'); 
                    return; 
                }
                
                const success = addTask({ shopInput, taskName: finalTaskName, orderQuantity }); 
                if (success) { 
                    setShopInput(shopInput); 
                    setTaskInput(''); 
                    setCustomTaskName(''); 
                    setOrderQuantity(''); 
                    setIsCustomTask(false); 
                    setErrorMessage(''); 
                } 
            };

            const optionClasses = `${themeClasses.cardBg} ${themeClasses.primaryText}`;
            return (
                <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                    <div className="flex flex-col gap-2 w-full">
                        <select value={shopInput} onChange={handleShopChange} className={`flex-1 px-5 py-3 border-2 ${themeClasses.cardBg} ${themeClasses.accentText} ${themeClasses.shopSelectBorder} rounded-full focus:outline-none transition-all font-semibold`} required>
                            <option value="" disabled className={optionClasses}>--- Seleccionar Tienda ---</option>
                            {shopOptions.map(o => <option key={o} value={o} className={optionClasses}>{o}</option>)}
                        </select>
                        
                        {!isCustomTask && (
                            <select value={taskInput} onChange={handleTaskChange} className={`flex-1 px-5 py-3 border-2 ${themeClasses.cardBg} ${themeClasses.secondaryText} ${themeClasses.inputBorder} rounded-full focus:outline-none transition-all`} required>
                                <option value="" disabled className={optionClasses}>Seleccionar tarea</option>
                                {taskOptions.map(o => <option key={o} value={o} className={optionClasses}>{o}</option>)}
                                <option value="OTHER_CUSTOM_TASK" className={optionClasses}>Otra</option>
                            </select>
                        )}
                        
                        {isCustomTask && (
                            <input type="text" value={customTaskName} onChange={e => setCustomTaskName(e.target.value)} placeholder="Nombre de la tarea" className={`flex-1 px-5 py-3 border-2 ${themeClasses.cardBg} ${themeClasses.secondaryText} ${themeClasses.inputBorder} rounded-full focus:outline-none transition-all`} required />
                        )}

                        <input type="number" value={orderQuantity} onChange={(e) => setOrderQuantity(e.target.value)} placeholder="Cantidad (opcional)" className={`flex-1 px-5 py-3 border-2 ${themeClasses.cardBg} ${themeClasses.secondaryText} ${themeClasses.inputBorder} rounded-full focus:outline-none transition-all`} />
                    </div>
                    {errorMessage && <p className="text-red-400 font-medium bg-red-900/50 p-3 rounded-xl text-center">{errorMessage}</p>}
                    <button type="submit" className={`px-6 py-3 rounded-full font-semibold transition duration-300 shadow-lg w-full sm:w-auto ${themeClasses.buttonAdd}`}>Agregar Tarea</button>
                    {isCustomTask && <button type="button" onClick={() => { setIsCustomTask(false); setTaskInput(''); }} className="text-gray-400 hover:text-white mt-2">Cancelar Tarea Personalizada</button>}
                </form>
            );
        };

        // --- SECTION: MAIN APP COMPONENT ---

        const App = () => {
            const { celebration, themeClasses } = useCelebration(birthdaysList);
            const { tasks, errorMessage, setErrorMessage, addTask, deleteTask, toggleTimer, updateTaskDetails, sortTasksByShop, resetTaskTimer, stopAllTimers, statusMessage, resumeStoppedTimers, clearStatusMessage } = useTasks();
            const [pastReports, setPastReports] = usePersistentState('reports', []);
            const [reportOutput, setReportOutput] = useState('');
            
            useEffect(() => { 
                document.getElementById('root').style.zIndex = '10'; 
                document.body.className = `${themeClasses.bodyBg} transition-colors duration-500`; 
            }, [themeClasses]);

            // L√≥gica de auto-desaparici√≥n del mensaje de status
            useEffect(() => {
                if (statusMessage) {
                    const timer = setTimeout(() => {
                        clearStatusMessage();
                    }, 8000); // 8 segundos para auto-desaparecer
                    return () => clearTimeout(timer);
                }
            }, [statusMessage, clearStatusMessage]);
            
            const generateReport = () => {
                const reportContent = generateEODRContent(tasks);
                setReportOutput(reportContent);
                const reportDocId = new Date().toISOString().slice(0, 10);
                const newReport = { id: reportDocId, content: reportContent };
                setPastReports(prev => {
                    const existingIdx = prev.findIndex(r => r.id === reportDocId);
                    if (existingIdx > -1) { const updated = [...prev]; updated[existingIdx] = newReport; return updated; }
                    return [...prev, newReport].sort((a, b) => b.id.localeCompare(a.id));
                });
            };

            const cardGlowClass = celebration.theme === 'halloween' ? 'glow-card' : (celebration.theme === 'party' || celebration.theme === 'biancaBday') ? 'party-glow-card' : '';

            // Verificar si hay alguna tarea activa
            const hasRunningTask = tasks.some(t => t.running);

            return (
                <>
                    <GlobalStatusMessage 
                        message={statusMessage}
                        resumeAction={resumeStoppedTimers}
                        dismissAction={clearStatusMessage}
                    />

                    <div className={`max-w-xl w-11/12 mx-auto rounded-2xl shadow-xl p-8 pt-12 transition-colors duration-500 ${themeClasses.cardBg} max-h-[95vh] overflow-y-auto hide-scrollbar relative ${cardGlowClass}`}>
                        {/* Fondos (z-index bajo) */}
                        <SpiderWeb isHalloween={celebration.theme === 'halloween'} />
                        
                        {/* Contenido */}
                        <div className="relative space-y-6"> 
                            <Title themeClasses={themeClasses} celebration={celebration} />
                            <TaskInputForm {...{ addTask, errorMessage, setErrorMessage, themeClasses }} />
                            
                            <div className="space-y-4">
                                <hr className={`border-t ${themeClasses.inputBorder}`} />

                                {/* CONTROLES GLOBALES DE TAREAS */}
                                <div className="flex flex-col sm:flex-row justify-between items-center gap-3">
                                    <button 
                                        onClick={sortTasksByShop} 
                                        className="bg-gray-600 text-white px-4 py-2 text-sm rounded-full font-semibold hover:bg-gray-700 transition duration-300 shadow-lg w-full sm:w-auto"
                                    >
                                        Ordenar por Tienda
                                    </button>
                                    
                                    {hasRunningTask && ( // Solo muestra el bot√≥n si hay al menos 1 tarea activa
                                        <button
                                            onClick={stopAllTimers}
                                            className={`bg-purple-700 hover:bg-purple-800 text-white px-4 py-2 text-sm rounded-full font-semibold transition duration-300 shadow-lg w-full sm:w-auto`}
                                            title="Detener todos los cron√≥metros activos"
                                        >
                                            Detener Todas las Tareas
                                        </button>
                                    )}
                                </div>

                                {tasks.length > 0 ? tasks.map((task) => (
                                    <TaskListItem 
                                        key={task.id} 
                                        task={task} 
                                        toggleTimer={toggleTimer} 
                                        deleteTask={deleteTask} 
                                        updateTaskDetails={updateTaskDetails} 
                                        themeClasses={themeClasses} 
                                        resetTaskTimer={resetTaskTimer} 
                                        celebrationTheme={celebration.theme} 
                                    />
                                )) : (<p className={`text-center italic ${themeClasses.secondaryText}`}>No hay tareas.</p>)}
                            </div>
                            
                            <div className="flex flex-col items-center">
                                <button onClick={generateReport} className={`px-6 py-3 rounded-full font-semibold transition duration-300 shadow-lg mb-4 ${themeClasses.buttonAction}`}>Generar E.O.D.R.</button>
                                <div className={`w-full p-5 rounded-xl font-mono text-sm whitespace-pre-wrap transition-colors duration-500 ${themeClasses.itemBg} ${themeClasses.secondaryText}`}>{reportOutput || 'El reporte aparecer√° aqu√≠...'}</div>
                            </div>
                            
                            <hr className={`border-t ${themeClasses.inputBorder}`} />
                            
                            <div className="space-y-4">
                                <h2 className={`text-2xl font-bold text-center ${themeClasses.primaryText}`}>Historial de Reportes</h2>
                                {pastReports.length > 0 ? (pastReports.map((report) => (<div key={report.id} className={`rounded-xl p-5 shadow-md transition-colors duration-500 ${themeClasses.itemBg}`}><pre className={`font-mono text-sm whitespace-pre-wrap ${themeClasses.secondaryText}`}>{report.content}</pre></div>))) : (<p className={`text-center italic ${themeClasses.secondaryText}`}>No hay reportes anteriores.</p>)}
                            </div>
                        </div>
                    </div>
                </>
            );
        };
        
        const ThemeWrapper = () => {
            const { celebration } = useCelebration(birthdaysList);
            return (
                <>
                    <BackgroundParticles isHalloween={celebration.theme === 'halloween'} /> 
                    <BackgroundGhost isHalloween={celebration.theme === 'halloween'} />
                    <BackgroundConfetti isParty={celebration.theme === 'party'} />
                    <BackgroundSnow isChristmas={celebration.theme === 'christmas'} />
                    <BackgroundChristmasLights isChristmas={celebration.theme === 'christmas'} />
                    <BackgroundMagic isBiancaBday={celebration.theme === 'biancaBday'} />
                    
                    <App />
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ThemeWrapper />);
    </script>
</body>
</html>
