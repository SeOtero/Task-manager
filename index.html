<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Task Manager TL</title>
    <!-- Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800;900&family=Creepster&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* #region GLOBAL STYLES & ANIMATIONS */
        body {
            font-family: 'Inter', sans-serif;
            width: 100vw; 
            height: 100vh;
            overflow-x: hidden; 
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        .font-creepster { font-family: 'Creepster', cursive; }
        .font-christmas { font-family: 'Mountains of Christmas', cursive; }
    
        .app-container {
            min-height: 100vh;
            padding-top: max(1rem, env(safe-area-inset-top)); 
            padding-bottom: max(1rem, env(safe-area-inset-bottom)); 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hide-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; }
        .hide-scrollbar { scrollbar-width: none; }

        /* Custom Scrollbar for Task List */
        .task-scroll::-webkit-scrollbar { width: 6px; }
        .task-scroll::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); border-radius: 4px; }
        .task-scroll::-webkit-scrollbar-thumb { background: rgba(150, 150, 150, 0.4); border-radius: 4px; }
        .task-scroll::-webkit-scrollbar-thumb:hover { background: rgba(150, 150, 150, 0.6); }

        /* Glow Animations */
        @keyframes subtle-container-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 140, 0, 0.4), 0 0 5px rgba(128, 0, 128, 0.2); }
            50% { box-shadow: 0 0 25px rgba(255, 165, 0, 0.7), 0 0 10px rgba(255, 215, 0, 0.5); }
        }
        .glow-card {
            animation: subtle-container-glow 6s infinite ease-in-out alternate;
            position: relative; 
            overflow: hidden;
            border: 1px solid rgba(50, 50, 50, 0.5); 
        }

        @keyframes party-container-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(217, 70, 239, 0.5), 0 0 8px rgba(34, 211, 238, 0.4); } 
            50% { box-shadow: 0 0 30px rgba(244, 63, 94, 0.7), 0 0 15px rgba(6, 182, 212, 0.6); }
        }
        .party-glow-card {
            animation: party-container-glow 5s infinite ease-in-out alternate;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(120, 80, 150, 0.5);
        }
        
        /* Specific Visual Effects */
        @keyframes particle-drift-and-fade {
            0% { transform: translate(0, 0) scale(0.8); opacity: 0; }
            25% { transform: translate(calc(var(--rand-x) * 0.25px), 25vh) scale(1); opacity: 0.5; }
            50% { transform: translate(calc(var(--rand-x) * 1.2px), 50vh) scale(1.1); opacity: 0.3; }
            75% { transform: translate(calc(var(--rand-x) * 0.5px), 75vh) scale(0.9); opacity: 0.1; }
            100% { transform: translate(calc(var(--rand-x) * 0.1px), 100vh) scale(0.5); opacity: 0; }
        }
        .particle {
            position: fixed; top: -10px; background-color: rgba(255, 165, 0, 0.4); 
            border-radius: 50%; box-shadow: 0 0 5px rgba(255, 165, 0, 0.6); 
            pointer-events: none; z-index: 1; 
        }
        .animate-particle { animation: particle-drift-and-fade var(--duration) linear infinite; }
        
        @keyframes confetti-fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: fixed; top: 0; pointer-events: none; z-index: 1;
            animation: confetti-fall var(--duration) linear infinite;
            animation-delay: var(--delay);
        }

        .spider-web {
            position: absolute; top: 0; left: 0; width: 150px; height: 150px;
            pointer-events: none; z-index: 2; opacity: 0.5;
        }
        .spider-web:before, .spider-web:after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%; border: 2px solid rgba(150, 150, 150, 0.4); 
            box-sizing: border-box; mix-blend-mode: screen;
        }
        .spider-web:before {
            transform: rotate(45deg) scaleX(0.5) translate(-10%, 10%);
            border-radius: 0; border-top: none; border-right: none;
            clip-path: polygon(0 0, 100% 0, 100% 50%, 0% 100%);
        }
        .spider-web:after {
            transform: rotate(-45deg) scaleX(0.5) translate(-10%, -10%);
            border-radius: 0; border-top: none; border-left: none;
            clip-path: polygon(100% 0, 0 0, 0 50%, 100% 100%);
        }
        .spider-web .line1, .spider-web .line2 {
            content: ''; position: absolute; background: rgba(150, 150, 150, 0.4);
        }
        .spider-web .line1 { width: 120px; height: 2px; top: 0; left: 0; transform-origin: top left; transform: rotate(25deg); }
        .spider-web .line2 { width: 120px; height: 2px; top: 0; left: 0; transform-origin: top left; transform: rotate(-25deg); }

        @keyframes snowfall {
            0% { transform: translateY(-10vh) translateX(0); }
            100% { transform: translateY(110vh) translateX(calc(var(--drift) * 15vw)); }
        }
        .snowflake {
            position: fixed; top: 0; background: white; border-radius: 50%;
            pointer-events: none; z-index: 1; opacity: 0.8;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
            animation: snowfall var(--duration) linear infinite;
            animation-delay: var(--delay);
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.6; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        .christmas-light {
            position: fixed; border-radius: 50%;
            animation: twinkle var(--duration) ease-in-out infinite alternate;
            z-index: 1; pointer-events: none;
        }

        @keyframes float-ghost {
            0% { transform: translate(var(--start-x), 100vh) scale(1); opacity: 0; }
            20% { opacity: 0.6; }
            80% { opacity: 0.6; }
            100% { transform: translate(var(--end-x), -20vh) scale(1.1); opacity: 0; }
        }
        .ghost {
            position: fixed; bottom: -150px; z-index: 1;
            pointer-events: none;
            animation: float-ghost var(--duration) ease-in-out infinite;
            animation-delay: var(--delay);
            fill: rgba(255, 255, 255, 0.1);
            filter: drop-shadow(0 0 15px rgba(200, 220, 255, 0.6));
        }
        
        @keyframes magic-float {
            0% { transform: translateY(110vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
        }
        .magic-particle {
            position: fixed; top: 0; pointer-events: none; z-index: 1;
            animation: magic-float var(--duration) linear infinite;
            animation-delay: var(--delay);
        }
        
        @keyframes modal-pop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .modal-content {
            animation: modal-pop 0.3s ease-out forwards;
        }

        @keyframes wiggle-badge {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }
        .wiggle-animation {
            animation: wiggle-badge 1s ease-in-out infinite;
        }

        @keyframes shine-sweep {
            0% { transform: translateX(-150%) skewX(-25deg); }
            100% { transform: translateX(150%) skewX(-25deg); }
        }
        .shine-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.7), transparent);
            animation: shine-sweep 3s infinite ease-in-out;
        }
        /* #endregion */
    </style>
</head>
<body class="bg-gray-900 transition-colors duration-500">

    <div id="root" class="app-container"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // #region CONSTANTS & DATA
        const birthdaysList = [
            { name: "Seba y Estefania", date: "12-08" },
            { name: "Bianca", date: "12-18" },
            { name: "Mica", date: "08-01" },
            { name: "Arturo", date: "04-01" },
            { name: "Mica", date: "11-21" },
            { name: "Angie", date: "11-19" }, 
            { name: "Dana", date: "08-28" },
            { name: "Iliana", date: "12-27" },
            { name: "Valentina", date: "09-03" },
        ];
        
        const shopOptions = ["Tienda Lujosa", "Clara Tienda", "Clara Tierra"];
        const CLARA_TIENDA_TASK_NAME = "Ã“rdenes / Tarea Ãšnica";
        
        const commonTaskOptions = [
            "Columna CONFIRMADO", "Columna POR UPSELL", "Columna DATOS ENTREGA", 
            "Columna RESPONDER", "Columna REMINDER", "Columna LATE VERIFICATION",
            "Chat en vivo (filtro Abiertos)", "Chat en vivo (filtro Pendiente)", 
            "Ordenes confirmadas sheet (CHECK info)", "CHAT Pending Orders",
            "Facebook/Instagram Comments & Chats", "Meeting"
        ];

        const shopSpecificCallTasks = {
            "Tienda Lujosa": "Llamadas TL", "Clara Tienda": "Llamadas CTienda", "Clara Tierra": "Llamadas CTierra"
        };
        // #endregion

        // #region THEME CONFIGURATION
        const THEME_STRATEGIES = {
            default: { 
                name: 'default',
                bodyBg: 'bg-gray-900', cardBg: 'bg-gray-800', itemBg: 'bg-gray-700', 
                primaryText: 'text-white', secondaryText: 'text-gray-300', accentText: 'text-yellow-300', 
                buttonAdd: 'bg-blue-600 hover:bg-blue-700', buttonAction: 'bg-purple-600 hover:bg-purple-700', 
                inputBorder: 'border-gray-600 focus:ring-blue-500', shopSelectBorder: 'border-yellow-600 focus:ring-yellow-500', 
                titleFont: '', calendarActive: 'bg-blue-600 text-white', calendarDot: 'bg-yellow-400', 
                modalBg: 'bg-gray-800 border-gray-600',
                activeEffects: [],
                iconPair: null
            },
            halloween: { 
                name: 'halloween',
                bodyBg: 'bg-gray-950', cardBg: 'bg-[#0a0a0a] shadow-2xl glow-card', itemBg: 'bg-gray-800/40 border border-gray-700/60', 
                primaryText: 'text-orange-500', secondaryText: 'text-gray-300', accentText: 'text-yellow-400', 
                buttonAdd: 'bg-orange-600 hover:bg-orange-700 text-white', buttonAction: 'bg-purple-700 hover:bg-purple-800 text-white', 
                inputBorder: 'border-gray-700 focus:ring-orange-500', shopSelectBorder: 'border-orange-500 focus:ring-orange-400', 
                titleFont: 'font-creepster tracking-widest', calendarActive: 'bg-orange-600 text-black font-bold', calendarDot: 'bg-purple-500', 
                modalBg: 'bg-gray-900 border-orange-600',
                activeEffects: ['particles', 'ghost', 'spiderweb'],
                iconPair: ['ðŸ‘»', 'ðŸŽƒ']
            },
            christmas: { 
                name: 'christmas',
                bodyBg: 'bg-red-900', cardBg: 'bg-green-900/90 backdrop-blur-sm', itemBg: 'bg-green-800/50 border border-yellow-300/30', 
                primaryText: 'text-white', secondaryText: 'text-gray-200', accentText: 'text-yellow-300', 
                buttonAdd: 'bg-red-600 hover:bg-red-700 text-white', buttonAction: 'bg-yellow-500 hover:bg-yellow-600 text-green-900', 
                inputBorder: 'border-red-400 focus:ring-red-300', shopSelectBorder: 'border-yellow-400 focus:ring-yellow-300', 
                titleFont: 'font-christmas', calendarActive: 'bg-red-600 text-white', calendarDot: 'bg-yellow-300', 
                modalBg: 'bg-green-900 border-yellow-400',
                activeEffects: ['snow', 'lights'],
                iconPair: ['ðŸŽ…', 'ðŸŽ„']
            },
            party: { 
                name: 'party',
                bodyBg: 'bg-black', cardBg: 'bg-gray-900/80 backdrop-blur-sm party-glow-card', itemBg: 'bg-gray-800/50 border border-purple-500/30', 
                primaryText: 'text-fuchsia-400', secondaryText: 'text-gray-200', accentText: 'text-cyan-400', 
                buttonAdd: 'bg-fuchsia-600 hover:bg-fuchsia-700 text-white', buttonAction: 'bg-cyan-500 hover:bg-cyan-600 text-white', 
                inputBorder: 'border-gray-600 focus:ring-fuchsia-500', shopSelectBorder: 'border-cyan-500 focus:ring-cyan-400', 
                titleFont: 'font-bold', calendarActive: 'bg-fuchsia-600 text-white', calendarDot: 'bg-cyan-400', 
                modalBg: 'bg-gray-900 border-fuchsia-500',
                activeEffects: ['confetti'],
                iconPair: ['ðŸŽ‰', 'ðŸŽ‚']
            },
            biancaBday: { 
                name: 'biancaBday',
                bodyBg: 'bg-black', cardBg: 'bg-gray-950/90 backdrop-blur-sm shadow-2xl shadow-purple-500/30 party-glow-card', itemBg: 'bg-gray-800/60 border border-purple-700/50', 
                primaryText: 'text-purple-400', secondaryText: 'text-red-400', accentText: 'text-pink-400', 
                buttonAdd: 'bg-red-600 hover:bg-red-700 text-white', buttonAction: 'bg-purple-600 hover:bg-purple-700 text-white', 
                inputBorder: 'border-gray-700 focus:ring-purple-500', shopSelectBorder: 'border-pink-400 focus:ring-pink-400', 
                titleFont: 'font-christmas', calendarActive: 'bg-pink-500 text-white', calendarDot: 'bg-purple-400', 
                modalBg: 'bg-gray-900 border-pink-500',
                activeEffects: ['magic'],
                iconPair: ['ðŸ¦„', 'ðŸ±']
            }
        };
        // #endregion

        // #region VISUAL COMPONENTS (EFFECTS)
        const BackgroundParticles = () => { const particles = useMemo(() => Array.from({ length: 80 }).map((_, i) => ({ key: i, left: `${Math.random() * 100}vw`, size: `${2 + Math.random() * 5}px`, duration: `${20 + Math.random() * 20}s`, delay: `${Math.random() * 15}s`, randX: `${(Math.random() - 0.5) * 350}` })), []); return (<div className="w-full h-full absolute top-0 left-0">{particles.map(p => <div key={p.key} className="particle animate-particle" style={{ left: p.left, width: p.size, height: p.size, '--duration': p.duration, '--rand-x': p.randX, animationDelay: p.delay }} />)}</div>); };
        const BackgroundConfetti = () => { const confettiPieces = useMemo(() => { const colors = ['#f43f5e', '#ec4899', '#8b5cf6', '#38bdf8']; return Array.from({ length: 100 }).map((_, i) => { const size = Math.random() * 8 + 4; const isSquare = Math.random() > 0.5; return { key: i, left: `${Math.random() * 100}vw`, width: `${size}px`, height: `${size}px`, backgroundColor: colors[Math.floor(Math.random() * colors.length)], borderRadius: isSquare ? '2px' : '50%', transform: `rotate(${Math.random() * 360}deg)`, '--duration': `${Math.random() * 5 + 5}s`, '--delay': `${Math.random() * 5}s` }; }); }, []); return (<div className="w-full h-full absolute top-0 left-0 overflow-hidden">{confettiPieces.map(style => <div key={style.key} className="confetti" style={style} />)}</div>); };
        const BackgroundSnow = () => { const snowflakes = useMemo(() => Array.from({ length: 150 }).map((_, i) => { const size = Math.random() * 4 + 2; return { key: i, left: `${Math.random() * 100}vw`, width: `${size}px`, height: `${size}px`, '--duration': `${Math.random() * 10 + 10}s`, '--delay': `${Math.random() * 10}s`, '--drift': Math.random() - 0.5 }; }), []); return (<div className="w-full h-full absolute top-0 left-0 overflow-hidden">{snowflakes.map(style => <div key={style.key} className="snowflake" style={style} />)}</div>); };
        const BackgroundChristmasLights = () => { const lights = useMemo(() => { const colors = ['#f44336', '#4caf50', '#2196f3', '#ffeb3b']; return Array.from({ length: 40 }).map((_, i) => { const size = Math.random() * 10 + 5; return { key: i, top: `${Math.random() * 100}vh`, left: `${Math.random() * 100}vw`, width: `${size}px`, height: `${size}px`, backgroundColor: colors[i % colors.length], boxShadow: `0 0 15px 5px ${colors[i % colors.length]}66`, '--duration': `${Math.random() * 2 + 1.5}s`, animationDelay: `${Math.random() * 2}s` }; }); }, []); return (<div className="w-full h-full absolute top-0 left-0">{lights.map(style => <div key={style.key} className="christmas-light" style={style} />)}</div>); };
        const BackgroundGhost = () => { const ghosts = useMemo(() => Array.from({ length: 5 }).map((_, i) => ({ key: i, '--duration': `${Math.random() * 15 + 10}s`, '--delay': `${Math.random() * 10}s`, '--start-x': `${Math.random() * 80 + 10}vw`, '--end-x': `${Math.random() * 80 + 10}vw`, width: `${Math.random() * 50 + 50}px` })), []); return (<div className="w-full h-full absolute top-0 left-0 overflow-hidden">{ghosts.map(style => (<svg key={style.key} className="ghost" style={style} viewBox="0 0 100 125"><path d="M10 115 C 10 115, 10 95, 20 95 C 30 95, 30 115, 30 115 C 30 115, 30 95, 40 95 C 50 95, 50 115, 50 115 C 50 115, 50 95, 60 95 C 70 95, 70 115, 70 115 C 70 115, 70 95, 80 95 C 90 95, 90 115, 90 115 L 90 60 C 90 20, 50 10, 50 10 C 50 10, 10 20, 10 60 Z M 30 60 C 35 60, 35 50, 30 50 C 25 50, 25 60, 30 60 Z M 70 60 C 75 60, 75 50, 70 50 C 65 50, 65 60, 70 60 Z" /></svg>))}</div>); };
        const BackgroundMagic = () => { const particles = useMemo(() => { const emojis = ['ðŸ¦„', 'ðŸ±', 'âœ¨', 'ðŸ’œ', 'â¤ï¸', 'ðŸ’–']; return Array.from({ length: 100 }).map((_, i) => { return { key: i, left: `${Math.random() * 100}vw`, fontSize: `${Math.random() * 1.5 + 0.75}rem`, opacity: Math.random() * 0.5 + 0.5, emoji: emojis[i % emojis.length], '--duration': `${Math.random() * 10 + 8}s`, '--delay': `${Math.random() * 8}s` }; }); }, []); return (<div className="w-full h-full absolute top-0 left-0 overflow-hidden">{particles.map(style => <div key={style.key} className="magic-particle" style={style}>{style.emoji}</div>)}</div>); };
        const SpiderWeb = () => { return (<><div className="spider-web"><div className="line1"></div><div className="line2"></div></div><div className="spider-web" style={{ left: 'auto', right: 0, transform: 'scaleX(-1)' }}><div className="line1"></div><div className="line2"></div></div></>); };

        const EFFECT_COMPONENTS = {
            'particles': BackgroundParticles,
            'ghost': BackgroundGhost,
            'confetti': BackgroundConfetti,
            'snow': BackgroundSnow,
            'lights': BackgroundChristmasLights,
            'magic': BackgroundMagic,
            'spiderweb': SpiderWeb
        };
        // #endregion

        // #region UTILITIES
        const formatTime = (ms) => {
            if (ms < 0) return '00:00:00';
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        };

        const parseTimeStringToMs = (timeStr) => {
            if (!timeStr) return 0;
            let hours = 0, minutes = 0, seconds = 0;
            if (timeStr.includes(':')) {
                const parts = timeStr.split(':').map(Number);
                if (parts.length === 3) { [hours, minutes, seconds] = parts; }
                else if (parts.length === 2) { [hours, minutes] = parts; }
            } else {
                minutes = parseInt(timeStr) || 0;
            }
            return (hours * 3600 + minutes * 60 + seconds) * 1000;
        };

        const getTodayID = () => {
             const today = new Date();
             const year = today.getFullYear();
             const month = String(today.getMonth() + 1).padStart(2, '0');
             const day = String(today.getDate()).padStart(2, '0');
             return `${year}-${month}-${day}`;
        };

        const generateEODRContent = (tasks, reportDate) => {
            let totalMilliseconds = 0;
            const tasksByShop = tasks.reduce((acc, task) => {
                const finalTime = task.running ? task.elapsedTime + (Date.now() - (task.lastTime || Date.now())) : task.elapsedTime;
                const shopName = task.shop || 'Sin Tienda';
                if (!acc[shopName]) acc[shopName] = [];
                acc[shopName].push({ ...task, finalTime });
                totalMilliseconds += finalTime;
                return acc;
            }, {});

            let formattedReport = [];
            Object.keys(tasksByShop).sort().forEach(shopName => {
                formattedReport.push(`--- ${shopName} ---`);
                tasksByShop[shopName].forEach(task => {
                    const totalSeconds = Math.floor(task.finalTime / 1000);
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const timeString = `${hours}h ${minutes}m`;
                    const quantityText = task.quantity ? ` (${task.quantity} orders)` : '';
                    const reportTaskName = task.rawTaskName || task.name.replace(` [${shopName}]`, '');
                    formattedReport.push(`${reportTaskName}${quantityText}: ${timeString}`);
                });
            });

            const totalSeconds = Math.floor(totalMilliseconds / 1000);
            const totalHours = Math.floor(totalSeconds / 3600);
            const totalMinutes = Math.floor((totalSeconds % 3600) / 60);
            const totalTimeString = `${totalHours}h ${totalMinutes}m`;
            
            const [y, m, d] = reportDate.split('-').map(Number);
            const displayDateObj = new Date(y, m - 1, d);
            const displayDate = displayDateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            return `End of Day Report: ${displayDate}\nHours worked: ${totalTimeString}\n\nToday I worked on the following tasks:\n${formattedReport.join('\n')}`;
        };

        const parseHoursFromReport = (content) => {
            if (!content) return 0;
            const match = content.match(/Hours worked: (\d+)h (\d+)m/);
            if (match) {
                const h = parseInt(match[1], 10);
                const m = parseInt(match[2], 10);
                return h + (m / 60);
            }
            return 0;
        };
        // #endregion

        // #region CUSTOM HOOKS
        const usePersistentState = (key, initialValue) => {
            const [state, setState] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) { console.error("Error reading from localStorage", error); return initialValue; }
            });
            useEffect(() => {
                try { window.localStorage.setItem(key, JSON.stringify(state)); } catch (error) { console.error("Error writing to localStorage", error); }
            }, [key, state]);
            return [state, setState];
        };

        const useThemeManager = (birthdays) => {
            const getBirthdayPerson = useCallback((birthdays) => {
                const today = new Date();
                const todayFormatted = `${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                const found = birthdays.find(b => b.date === todayFormatted);
                return found ? found.name : null;
            }, []);

            const themeData = useMemo(() => {
                const today = new Date();
                const month = today.getMonth() + 1;
                const birthdayPerson = getBirthdayPerson(birthdays);
                
                let themeKey = 'default';
                let message = '';
                
                if (birthdayPerson) {
                    if (birthdayPerson === "Bianca") {
                        themeKey = 'biancaBday';
                        message = `Â¡Feliz CumpleaÃ±os Bianca! ðŸ¦„ðŸ±`;
                    } else {
                        themeKey = 'party';
                        message = `Â¡Feliz CumpleaÃ±os ${birthdayPerson}! ðŸŽ‰`;
                    }
                } 
                else if (month === 10) { themeKey = 'halloween'; message = 'Â¡Feliz Halloween!'; } 
                else if (month === 12) { themeKey = 'christmas'; message = 'Â¡Feliz Navidad!'; }
                
                const strategy = THEME_STRATEGIES[themeKey] || THEME_STRATEGIES.default;
                return { strategy, message };
            }, [birthdays, getBirthdayPerson]);
            
            return themeData;
        };

        const useTasks = () => {
            const [tasks, setTasks] = usePersistentState('tasks', []);
            const [errorMessage, setErrorMessage] = useState('');
            const [statusMessage, setStatusMessage] = useState(null); 

            useEffect(() => {
                const interval = setInterval(() => {
                    setTasks(currentTasks => currentTasks.map(t => {
                        if (!t.running) return t; 
                        const now = Date.now();
                        const timeDiff = now - (t.lastTime || now);
                        if (isNaN(t.elapsedTime) || isNaN(timeDiff)) {
                            return { ...t, running: false, elapsedTime: 0, lastTime: null };
                        }
                        return { 
                            ...t, 
                            elapsedTime: t.elapsedTime + timeDiff, 
                            lastTime: now 
                        };
                    }));
                }, 1000);
                return () => clearInterval(interval);
            }, [setTasks]);
            
            const addTask = useCallback((taskData) => {
                const { shopInput, taskName, orderQuantity } = taskData;
                if (!shopInput || !taskName) { setErrorMessage('Completa todos los campos.'); return false; }
                const fullTaskName = `${taskName} [${shopInput}]`;
                if (tasks.some(t => t.name.toLowerCase() === fullTaskName.toLowerCase())) { 
                    setErrorMessage(`La tarea "${fullTaskName}" ya existe.`); 
                    return false; 
                }
                
                const isCommon = commonTaskOptions.includes(taskName);
                const isSpecific = Object.values(shopSpecificCallTasks).includes(taskName);
                const isCustom = !isCommon && !isSpecific;

                const newTask = { id: Date.now() + Math.random(), name: fullTaskName, rawTaskName: taskName, shop: shopInput, quantity: orderQuantity ? parseInt(orderQuantity) : null, elapsedTime: 0, running: false, lastTime: null, isCustom };
                setTasks(prev => [...prev, newTask]);
                setErrorMessage('');
                return true;
            }, [tasks, setTasks]);
            
            const deleteTask = useCallback((id) => setTasks(prev => prev.filter(t => t.id !== id)), [setTasks]);
            const deleteAllTasks = useCallback(() => { setTasks([]); setErrorMessage(''); }, [setTasks]);
            
            const toggleTimer = useCallback((id) => {
                setTasks(prev => {
                    const now = Date.now();
                    return prev.map(t => {
                        if (t.running && t.id !== id) return { ...t, running: false, elapsedTime: t.elapsedTime + (now - t.lastTime), lastTime: null };
                        if (t.id === id) {
                            const newRunning = !t.running;
                            return { ...t, running: newRunning, elapsedTime: newRunning ? t.elapsedTime : (t.elapsedTime + (now - t.lastTime)), lastTime: newRunning ? now : null };
                        }
                        return t;
                    });
                });
            }, [setTasks]);

            const stopAllTimers = useCallback(() => {
                let tasksStopped = false;
                let lastRunningTaskId = null;
                const now = Date.now();
                setTasks(prev => {
                    const newTasks = prev.map(t => {
                        if (t.running) {
                            tasksStopped = true;
                            lastRunningTaskId = t.id;
                            return { ...t, running: false, elapsedTime: t.elapsedTime + (now - t.lastTime), lastTime: null };
                        }
                        return t;
                    });
                    if (!tasksStopped) { setStatusMessage({ text: 'No hay tareas activas para detener.', taskIdToResume: null }); return prev; }
                    setStatusMessage({ text: `Todas las tareas han sido detenidas. (Ãšltima: ${newTasks.find(t => t.id === lastRunningTaskId)?.rawTaskName || 'N/A'})`, taskIdToResume: lastRunningTaskId });
                    return newTasks;
                });
            }, [setTasks]);

            const resumeStoppedTimers = useCallback(() => { if (!statusMessage || statusMessage.taskIdToResume === null) return; toggleTimer(statusMessage.taskIdToResume); setStatusMessage(null); }, [statusMessage, toggleTimer]);
            const clearStatusMessage = useCallback(() => { setStatusMessage(null); }, []);
            
            const resetTaskTimer = useCallback((id) => {
                setTasks(prev => prev.map(t => t.id === id ? { ...t, elapsedTime: 0, running: false, lastTime: null, quantity: null } : t));
            }, [setTasks]);
            
            const updateTaskDetails = useCallback((id, newDetails) => {
                setTasks(prev => prev.map(t => {
                    if (t.id === id) {
                        const newRawTaskName = newDetails.rawTaskName !== undefined ? newDetails.rawTaskName : t.rawTaskName;
                        const newShop = newDetails.shop !== undefined ? newDetails.shop : t.shop;
                        const newFullName = newRawTaskName ? `${newRawTaskName} [${newShop}]` : t.name;
                        if (prev.some(et => et.id !== id && et.name.toLowerCase() === newFullName.toLowerCase())) { setErrorMessage('Esa Tarea+Tienda ya existe.'); return t; }
                        setErrorMessage('');
                        return { ...t, ...newDetails, rawTaskName: newRawTaskName, shop: newShop, name: newFullName };
                    }
                    return t;
                }));
            }, [setTasks]);

            const syncTasksTime = useCallback((diffMs, distributionMode, targetTaskId) => {
                setTasks(prev => {
                    const now = Date.now();
                    if (distributionMode === 'all') {
                        const count = prev.length;
                        if (count === 0) return prev;
                        const perTask = Math.floor(diffMs / count);
                        const remainder = diffMs % count;
                        return prev.map((t, index) => {
                            const currentTaskTime = t.running ? t.elapsedTime + (now - t.lastTime) : t.elapsedTime;
                            let extra = perTask;
                            if (index === 0) extra += remainder;
                            let newElapsedTime = currentTaskTime + extra;
                            if (newElapsedTime < 0) newElapsedTime = 0;
                            return { ...t, elapsedTime: newElapsedTime, lastTime: t.running ? now : null };
                        });
                    } else {
                        return prev.map(t => {
                            if (t.id == targetTaskId) {
                                const currentTaskTime = t.running ? t.elapsedTime + (now - t.lastTime) : t.elapsedTime;
                                let newElapsedTime = currentTaskTime + diffMs;
                                if (newElapsedTime < 0) newElapsedTime = 0;
                                return { ...t, elapsedTime: newElapsedTime, lastTime: t.running ? now : null };
                            }
                            return t;
                        });
                    }
                });
            }, [setTasks]);

            const sortTasksByShop = useCallback(() => setTasks(prev => [...prev].sort((a, b) => a.shop.localeCompare(b.shop))), [setTasks]);
            return { tasks, errorMessage, setErrorMessage, addTask, deleteTask, deleteAllTasks, toggleTimer, updateTaskDetails, sortTasksByShop, resetTaskTimer, stopAllTimers, statusMessage, resumeStoppedTimers, clearStatusMessage, syncTasksTime };
        };
        // #endregion

        // #region UI COMPONENTS (SMALL)
        const Title = ({ themeClasses, celebrationMessage }) => { 
            const shadowStyle = themeClasses.name === 'halloween' ? '[text-shadow:0_0_8px_rgba(255,165,0,0.6)]' : themeClasses.name === 'party' ? '[text-shadow:0_0_10px_rgba(217,70,239,0.7)]' : themeClasses.name === 'biancaBday' ? '[text-shadow:0_0_12px_rgba(236,72,153,0.6)]' : '';
            const [leftIcon, rightIcon] = themeClasses.iconPair || [null, null];
            return (
                <div className="text-center mb-4">
                    <h1 className={`text-4xl font-extrabold transition-colors duration-500 ${themeClasses.primaryText} ${themeClasses.titleFont} ${shadowStyle}`}>
                        {leftIcon && <span className="inline-block transform -rotate-12 scale-110 mr-2 text-3xl">{leftIcon}</span>}
                        Task Manager TL
                        {rightIcon && <span className="inline-block transform rotate-12 scale-110 ml-2 text-3xl">{rightIcon}</span>}
                    </h1>
                    {celebrationMessage && <p className={`mt-2 text-lg font-semibold animate-pulse ${themeClasses.accentText}`}>{celebrationMessage}</p>}
                </div>
            );
        };
        
        const TaskListItem = ({ task, toggleTimer, deleteTask, updateTaskDetails, themeClasses, resetTaskTimer, celebrationThemeName }) => {
            const [isEditingTime, setIsEditingTime] = useState(false); 
            const [editedTime, setEditedTime] = useState(formatTime(task.elapsedTime)); 
            const [isEditingQuantity, setIsEditingQuantity] = useState(false); 
            const [editedQuantity, setEditedQuantity] = useState(task.quantity || ''); 
            const [isEditingShop, setIsEditingShop] = useState(false); 
            const [editedShop, setEditedShop] = useState(task.shop); 
            const [isEditingName, setIsEditingName] = useState(false); 
            const [editedName, setEditedName] = useState(task.rawTaskName);
            const [isConfirmingReset, setIsConfirmingReset] = useState(false);
            const [isConfirmingDelete, setIsConfirmingDelete] = useState(false);
            
            const currentElapsedTime = task.running ? task.elapsedTime + (Date.now() - (task.lastTime || Date.now())) : task.elapsedTime; 
            const isCustomTask = task.isCustom; 
            
            const handleTimeEdit = () => { const parts = editedTime.split(':').map(Number); if (parts.length === 3 && !parts.some(isNaN)) { const totalMs = (parts[0] * 3600 + parts[1] * 60 + parts[2]) * 1000; updateTaskDetails(task.id, { elapsedTime: totalMs }); } setIsEditingTime(false); };
            const handleQuantityEdit = () => { updateTaskDetails(task.id, { quantity: parseInt(editedQuantity) || null }); setIsEditingQuantity(false); };
            const handleShopEdit = () => { if (editedShop) updateTaskDetails(task.id, { shop: editedShop }); setIsEditingShop(false); };
            const handleNameEdit = () => { const nameToUpdate = editedName.trim() || 'Tarea sin Nombre'; updateTaskDetails(task.id, { rawTaskName: nameToUpdate }); setIsEditingName(false); };
            const handleResetClick = () => { resetTaskTimer(task.id); setIsConfirmingReset(false); };
            const handleDeleteConfirm = () => { deleteTask(task.id); setIsConfirmingDelete(false); };

            const runningBorderClass = task.running ? (celebrationThemeName === 'biancaBday' ? 'border-l-4 border-pink-400' : 'border-l-4 border-green-500') : 'border-l-4 border-gray-600';
            const buttonIncrementClass = task.running ? 'bg-green-600 hover:bg-green-700' : themeClasses.buttonAdd.replace('w-full sm:w-auto', '').replace('py-3', 'py-1').replace('px-6', 'px-2');
            const taskNameClass = isCustomTask ? 'cursor-pointer hover:opacity-80' : 'cursor-default';

            return (
                <div className={`flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 p-4 rounded-xl shadow-md ${themeClasses.itemBg} ${runningBorderClass}`}>
                    <div className="flex flex-col gap-1 min-w-0 flex-grow">
                        {isEditingShop ? (
                            <select value={editedShop} onChange={(e) => setEditedShop(e.target.value)} onBlur={handleShopEdit} onKeyPress={(e) => e.key === 'Enter' && handleShopEdit()} className={`px-2 py-1 border-b-2 bg-transparent focus:outline-none w-full sm:w-32 rounded ${themeClasses.accentText} border-pink-500`} autoFocus>
                                {shopOptions.map(o => <option key={o} value={o}>{o}</option>)}
                            </select>
                        ) : ( <span className={`font-bold text-sm transition-colors ${themeClasses.accentText} cursor-pointer hover:opacity-80`} onClick={() => { setEditedShop(task.shop); setIsEditingShop(true); }}> {task.shop || 'Sin Tienda'} </span> )}
                        {isEditingName && isCustomTask ? (
                            <input type="text" value={editedName} onChange={(e) => setEditedName(e.target.value)} onBlur={handleNameEdit} onKeyPress={(e) => e.key === 'Enter' && handleNameEdit()} className={`font-medium text-lg border-b-2 bg-transparent focus:outline-none w-full ${themeClasses.secondaryText} border-pink-500`} autoFocus />
                        ) : ( <span className={`font-medium text-lg break-words ${taskNameClass} ${themeClasses.secondaryText}`} onClick={() => { if (isCustomTask) { setEditedName(task.rawTaskName); setIsEditingName(true); } }}> {task.rawTaskName || task.name} </span> )}
                        {isEditingQuantity ? (
                            <input type="number" value={editedQuantity} onChange={(e) => setEditedQuantity(e.target.value)} onBlur={handleQuantityEdit} onKeyPress={(e) => e.key === 'Enter' && handleQuantityEdit()} className={`font-mono text-lg border-b-2 bg-transparent focus:outline-none w-full sm:w-24 ${themeClasses.secondaryText} border-blue-500`} autoFocus />
                        ) : ( <div className="flex items-center gap-2"> <span className={`font-mono text-base cursor-pointer hover:opacity-80 transition-colors ${themeClasses.secondaryText}`} onClick={() => { setEditedQuantity(task.quantity || ''); setIsEditingQuantity(true); }}> {task.quantity ? `${task.quantity} Ã³rdenes` : '(sin cantidad)'} </span> <button onClick={() => updateTaskDetails(task.id, { quantity: (task.quantity || 0) + 1 })} className={`text-xs px-3 py-1 rounded-full text-white font-bold transition duration-200 shadow-md ${buttonIncrementClass} hover:scale-105`} title="AÃ±adir 1 Orden"> +1 </button> </div> )}
                    </div>
                    <div className="flex items-center justify-between sm:justify-end gap-3 w-full sm:w-auto flex-shrink-0 pt-4 sm:pt-0 mt-4 sm:mt-0 border-t border-gray-700/60 sm:border-none">
                        {isEditingTime ? ( <input type="text" value={editedTime} onChange={(e) => setEditedTime(e.target.value)} onBlur={handleTimeEdit} onKeyPress={(e) => e.key === 'Enter' && handleTimeEdit()} placeholder="HH:MM:SS" className={`font-mono text-xl border-b-2 bg-transparent focus:outline-none w-28 ${themeClasses.primaryText} border-blue-500`} autoFocus /> ) : ( <span className={`font-mono text-xl cursor-pointer hover:opacity-80 transition-colors ${themeClasses.primaryText}`} onClick={() => { setEditedTime(formatTime(currentElapsedTime)); setIsEditingTime(true); }}> {formatTime(currentElapsedTime)} </span> )}
                        <div className="flex flex-col sm:flex-row sm:items-center items-end gap-2 flex-grow sm:flex-grow-0">
                            <button onClick={() => toggleTimer(task.id)} className={`px-4 py-2 rounded-full text-white font-semibold transition duration-300 shadow-md ${task.running ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} w-full sm:w-auto`}> {task.running ? 'Detener' : 'Iniciar'} </button>
                           <div className="flex items-center justify-end gap-2">
                               {isConfirmingReset ? ( <><button onClick={handleResetClick} className="p-2 text-white bg-red-600 rounded-full hover:bg-red-700 transition duration-300" title="Confirmar Reinicio y Cantidad"> <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"> <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /> </svg> </button> <button onClick={() => setIsConfirmingReset(false)} className="p-2 text-gray-400 hover:text-white transition duration-300" title="Cancelar"> <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"> <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" /> </svg> </button></> ) : ( <><button onClick={() => { setIsConfirmingReset(true); setIsConfirmingDelete(false); }} className="p-2 text-gray-400 hover:text-pink-500 transition duration-300" title="Reiniciar CronÃ³metro y Cantidad"> <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}> <path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2A8.001 8.001 0 0019.418 15m0 0H15" /> </svg> </button></> )}
                               {isConfirmingDelete ? (
                                   <>
                                       <button onClick={handleDeleteConfirm} className="p-2 text-white bg-red-600 rounded-full hover:bg-red-700 transition duration-300 shadow-lg animate-pulse" title="Confirmar Eliminar">
                                           <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                                       </button>
                                       <button onClick={() => setIsConfirmingDelete(false)} className="p-2 text-gray-400 hover:text-white transition duration-300" title="Cancelar">
                                           <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" /></svg>
                                       </button>
                                   </>
                               ) : (
                                   <button onClick={() => { setIsConfirmingDelete(true); setIsConfirmingReset(false); }} className="p-2 text-gray-400 hover:text-red-500 transition duration-300" title="Eliminar Tarea">
                                       <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg>
                                   </button>
                               )}
                           </div>
                        </div>
                    </div>
                </div>
            );
        };

        const GlobalStatusMessage = ({ message, resumeAction, dismissAction }) => {
            if (!message) return null;
            const isSuccess = message.taskIdToResume !== null;
            const bgColor = isSuccess ? 'bg-green-700/80' : 'bg-yellow-700/80';
            const borderColor = isSuccess ? 'border-green-400' : 'border-yellow-400';
            return (
                <div className={`fixed top-0 left-0 w-full p-4 z-[60] backdrop-blur-sm transition-all duration-300 transform translate-y-0`}>
                    <div className={`max-w-xl mx-auto p-4 rounded-xl shadow-2xl flex flex-col sm:flex-row items-center justify-between gap-3 ${bgColor} border ${borderColor} text-white`}>
                        <p className="font-semibold text-center sm:text-left flex-grow">{message.text}</p>
                        <div className="flex gap-3 flex-shrink-0">
                            {message.taskIdToResume !== null && ( <button onClick={resumeAction} className={`px-4 py-2 text-sm font-bold rounded-full bg-blue-500 hover:bg-blue-600 transition duration-200 shadow-md`}> Reanudar Tarea </button> )}
                            <button onClick={dismissAction} className="px-4 py-2 text-sm font-bold rounded-full bg-gray-600 hover:bg-gray-700 transition duration-200"> Cerrar </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ReportViewer = ({ content, themeClasses, placeholder }) => {
            const [isCopied, setIsCopied] = useState(false);
            const handleCopy = () => {
                if (!content) return;
                if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(content).then(() => { setIsCopied(true); setTimeout(() => setIsCopied(false), 2000); }); } else { const textArea = document.createElement("textarea"); textArea.value = content; document.body.appendChild(textArea); textArea.select(); try { document.execCommand('copy'); setIsCopied(true); setTimeout(() => setIsCopied(false), 2000); } catch (err) { console.error('Fallback copy failed', err); } document.body.removeChild(textArea); }
            };
            return (
                <div className="relative w-full group">
                    <div className={`w-full p-5 rounded-xl font-mono text-sm whitespace-pre-wrap transition-colors duration-500 ${themeClasses.itemBg} ${themeClasses.secondaryText} min-h-[100px]`}>
                        {content || <p className="text-center opacity-70 italic pt-8">{placeholder}</p>}
                    </div>
                    {content && (
                        <button onClick={handleCopy} className={`absolute top-2 right-2 px-3 py-1 text-xs font-bold rounded transition-all duration-200 shadow-md flex items-center gap-1 ${isCopied ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-200 hover:bg-gray-600'}`} title="Copiar reporte">
                            {isCopied ? ( <><svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>Â¡Copiado!</> ) : ( <><svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>Copiar</> )}
                        </button>
                    )}
                </div>
            );
        };
        // #endregion

        // #region UI COMPONENTS (COMPLEX)
        const CalendarWidget = ({ reports = [], selectedDate, onSelectDate, themeClasses }) => {
            const [viewDate, setViewDate] = useState(new Date());
            const daysInMonth = useMemo(() => { const year = viewDate.getFullYear(); const month = viewDate.getMonth(); return new Date(year, month + 1, 0).getDate(); }, [viewDate]);
            const startDay = useMemo(() => { const year = viewDate.getFullYear(); const month = viewDate.getMonth(); return new Date(year, month, 1).getDay(); }, [viewDate]);
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const weekDays = ["D", "L", "M", "M", "J", "V", "S"];
            const handlePrevMonth = () => { setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() - 1, 1)); };
            const handleNextMonth = () => { setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 1)); };
            const generateCalendarDays = () => {
                const days = [];
                for (let i = 0; i < startDay; i++) { days.push(<div key={`empty-${i}`} className="h-10 w-10"></div>); }
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateObj = new Date(viewDate.getFullYear(), viewDate.getMonth(), day);
                    const dateString = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
                    const isSelected = selectedDate === dateString;
                    const hasReport = Array.isArray(reports) && reports.some(r => r.id === dateString);
                    const isToday = dateString === getTodayID();
                    let bgClass = "hover:bg-gray-600/50";
                    let textClass = themeClasses.secondaryText;
                    if (isSelected) { bgClass = themeClasses.calendarActive || 'bg-blue-600 text-white'; textClass = "text-white font-bold"; } else if (isToday) { bgClass = "border border-gray-500 bg-gray-700/50"; }
                    days.push( <div key={day} onClick={() => onSelectDate(dateString)} className={`h-10 w-10 flex flex-col items-center justify-center rounded-full cursor-pointer transition-all relative ${bgClass} ${textClass}`}> <span className="text-sm z-10">{day}</span> {hasReport && ( <div className={`absolute bottom-1 w-1.5 h-1.5 rounded-full ${themeClasses.calendarDot || 'bg-yellow-400'}`}></div> )} </div> );
                }
                return days;
            };
            return (
                <div className={`p-4 rounded-xl shadow-lg ${themeClasses.itemBg} transition-colors duration-500`}>
                    <div className="flex justify-between items-center mb-4"> <button onClick={handlePrevMonth} className={`p-1 rounded-full hover:bg-gray-600/50 ${themeClasses.primaryText}`}>&lt;</button> <span className={`font-bold text-lg ${themeClasses.primaryText}`}>{monthNames[viewDate.getMonth()]} {viewDate.getFullYear()}</span> <button onClick={handleNextMonth} className={`p-1 rounded-full hover:bg-gray-600/50 ${themeClasses.primaryText}`}>&gt;</button> </div>
                    <div className="grid grid-cols-7 gap-1 text-center mb-2"> {weekDays.map(d => (<div key={d} className={`text-xs font-bold ${themeClasses.secondaryText} opacity-70`}>{d}</div>))} </div>
                    <div className="grid grid-cols-7 gap-1 justify-items-center"> {generateCalendarDays()} </div>
                </div>
            );
        };
        
        const MultiSelectCalendar = ({ reports = [], selectedDates, onToggleDate, onBatchUpdate, themeClasses }) => {
            const [viewDate, setViewDate] = useState(new Date());
            const daysInMonth = useMemo(() => { const year = viewDate.getFullYear(); const month = viewDate.getMonth(); return new Date(year, month + 1, 0).getDate(); }, [viewDate]);
            const startDay = useMemo(() => { const year = viewDate.getFullYear(); const month = viewDate.getMonth(); return new Date(year, month, 1).getDay(); }, [viewDate]);
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const weekDays = ["D", "L", "M", "M", "J", "V", "S"];
            const handlePrevMonth = () => { setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() - 1, 1)); };
            const handleNextMonth = () => { setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 1)); };
            
            const getCurrentMonthDates = () => {
                const year = viewDate.getFullYear();
                const month = viewDate.getMonth();
                const dates = [];
                for (let day = 1; day <= daysInMonth; day++) {
                    dates.push(`${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                }
                return dates;
            };

            const handleSelectAll = () => { if (onBatchUpdate) onBatchUpdate(getCurrentMonthDates(), 'add'); };
            const handleDeselectAll = () => { if (onBatchUpdate) onBatchUpdate(getCurrentMonthDates(), 'remove'); };
            
            const generateCalendarDays = () => {
                const days = [];
                for (let i = 0; i < startDay; i++) { days.push(<div key={`empty-${i}`} className="h-10 w-10"></div>); }
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateObj = new Date(viewDate.getFullYear(), viewDate.getMonth(), day);
                    const dateString = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
                    const isSelected = selectedDates.includes(dateString);
                    const hasReport = Array.isArray(reports) && reports.some(r => r.id === dateString);
                    let bgClass = "hover:bg-gray-600/50";
                    let textClass = themeClasses.secondaryText;
                    if (isSelected) { bgClass = 'bg-green-600 text-white font-bold border border-green-400'; textClass = "text-white"; } 
                    days.push( <div key={day} onClick={() => onToggleDate(dateString)} className={`h-10 w-10 flex flex-col items-center justify-center rounded-full cursor-pointer transition-all relative ${bgClass} ${textClass}`}> <span className="text-sm z-10">{day}</span> {hasReport && ( <div className={`absolute bottom-1 w-1.5 h-1.5 rounded-full ${isSelected ? 'bg-white' : (themeClasses.calendarDot || 'bg-yellow-400')}`}></div> )} </div> );
                }
                return days;
            };
            
            return (
                <div className={`p-4 rounded-xl shadow-lg border transition-colors duration-500 ${themeClasses.cardBg} ${themeClasses.inputBorder}`}>
                    <div className="flex justify-between items-center mb-4"> 
                        <button onClick={handlePrevMonth} className={`p-1 rounded-full hover:bg-gray-600/50 ${themeClasses.primaryText}`}>&lt;</button> 
                        <span className={`font-bold text-lg ${themeClasses.primaryText}`}>{monthNames[viewDate.getMonth()]} {viewDate.getFullYear()}</span> 
                        <button onClick={handleNextMonth} className={`p-1 rounded-full hover:bg-gray-600/50 ${themeClasses.primaryText}`}>&gt;</button> 
                    </div>
                    <div className="flex gap-2 mb-3 justify-center">
                        <button onClick={handleSelectAll} className="text-xs px-3 py-1 bg-green-700 hover:bg-green-600 text-white rounded-full transition">Todos</button>
                        <button onClick={handleDeselectAll} className="text-xs px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-full transition">Ninguno</button>
                    </div>
                    <div className="grid grid-cols-7 gap-1 text-center mb-2"> {weekDays.map(d => (<div key={d} className={`text-xs font-bold opacity-70 ${themeClasses.secondaryText}`}>{d}</div>))} </div>
                    <div className="grid grid-cols-7 gap-1 justify-items-center"> {generateCalendarDays()} </div>
                </div>
            );
        };
        
        const TaskInputForm = ({ addTask, errorMessage, setErrorMessage, themeClasses }) => {
            const [shopInput, setShopInput] = useState(''); 
            const [selectedTasks, setSelectedTasks] = useState([]);
            const [customTaskName, setCustomTaskName] = useState(''); 
            const [orderQuantity, setOrderQuantity] = useState(''); 
            const [isGridOpen, setIsGridOpen] = useState(false);
            
            useEffect(() => { setSelectedTasks([]); if (shopInput) setIsGridOpen(true); }, [shopInput]);

            const availableTasks = useMemo(() => {
                let options = [...commonTaskOptions];
                if (shopInput && shopSpecificCallTasks[shopInput]) { options = [shopSpecificCallTasks[shopInput], ...options]; }
                return options;
            }, [shopInput]);

            const handleShopChange = (e) => { setShopInput(e.target.value); };
            const toggleTaskSelection = (taskName) => {
                if (!shopInput) return;
                setSelectedTasks(prev => {
                    if (prev.includes(taskName)) return prev.filter(t => t !== taskName);
                    return [...prev, taskName];
                });
            };

            const handleSubmit = (e) => { 
                e.preventDefault(); 
                if (!shopInput) { setErrorMessage('Primero selecciona una tienda.'); return; }
                if (selectedTasks.length === 0) { setErrorMessage('Selecciona al menos una tarea.'); return; }
                let anySuccess = false;
                selectedTasks.forEach(taskName => {
                    let finalName = taskName;
                    if (taskName === "OTHER_CUSTOM_TASK") {
                        if (!customTaskName.trim()) return; 
                        finalName = customTaskName.trim();
                    }
                    const success = addTask({ shopInput, taskName: finalName, orderQuantity });
                    if(success) anySuccess = true;
                });
                if (anySuccess) { setSelectedTasks([]); setCustomTaskName(''); setOrderQuantity(''); setErrorMessage(''); }
            };
            
            const optionClasses = `${themeClasses.cardBg} ${themeClasses.primaryText}`;
            const isCustomSelected = selectedTasks.includes("OTHER_CUSTOM_TASK");

            return (
                <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                    <div className="flex flex-col gap-3 w-full">
                        <select value={shopInput} onChange={handleShopChange} className={`flex-1 px-5 py-3 border-2 ${themeClasses.cardBg} ${themeClasses.accentText} ${themeClasses.shopSelectBorder} rounded-full focus:outline-none transition-all font-semibold`} required> 
                            <option value="" disabled className={optionClasses}>--- Seleccionar Tienda ---</option> 
                            {shopOptions.map(o => <option key={o} value={o} className={optionClasses}>{o}</option>)} 
                        </select>
                        {shopInput && (
                            <div className="flex flex-col gap-2">
                                <div className="flex justify-between items-center px-2">
                                    <span className={`text-xs uppercase font-bold tracking-widest ${themeClasses.secondaryText} opacity-70`}>Tareas Disponibles</span>
                                    <button type="button" onClick={() => setIsGridOpen(!isGridOpen)} className={`text-[10px] font-bold px-2 py-1 rounded border border-gray-600 ${themeClasses.secondaryText} hover:bg-gray-700 transition`}>{isGridOpen ? 'OCULTAR â–²' : 'MOSTRAR â–¼'}</button>
                                </div>
                                {isGridOpen && (
                                    <div className={`p-3 rounded-xl border ${themeClasses.inputBorder} ${themeClasses.cardBg} max-h-60 overflow-y-auto task-scroll`}>
                                        <div className="flex flex-wrap gap-2 justify-center">
                                            {availableTasks.map(task => {
                                                const isSelected = selectedTasks.includes(task);
                                                return ( <button key={task} type="button" onClick={() => toggleTaskSelection(task)} className={`text-xs px-3 py-2 rounded-lg font-medium transition-all border ${isSelected ? 'bg-green-600 text-white border-green-400 shadow-md transform scale-105' : `bg-transparent ${themeClasses.secondaryText} ${themeClasses.inputBorder} hover:bg-gray-700`}`}> {task} </button> );
                                            })}
                                            <button type="button" onClick={() => toggleTaskSelection("OTHER_CUSTOM_TASK")} className={`text-xs px-3 py-2 rounded-lg font-medium transition-all border ${isCustomSelected ? 'bg-purple-600 text-white border-purple-400 shadow-md' : `bg-transparent text-purple-300 border-purple-900/50 hover:bg-purple-900/20`}`}> + Otra </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        {isCustomSelected && isGridOpen && ( <input type="text" value={customTaskName} onChange={e => setCustomTaskName(e.target.value)} placeholder="Nombre de la tarea personalizada..." className={`flex-1 px-5 py-3 border-2 ${themeClasses.cardBg} ${themeClasses.secondaryText} ${themeClasses.inputBorder} rounded-full focus:outline-none transition-all animate-pulse`} required /> )}
                        {isGridOpen && ( <input type="number" value={orderQuantity} onChange={(e) => setOrderQuantity(e.target.value)} placeholder="Cantidad (opcional - aplica a todas)" className={`flex-1 px-5 py-3 border-2 ${themeClasses.cardBg} ${themeClasses.secondaryText} ${themeClasses.inputBorder} rounded-full focus:outline-none transition-all`} /> )}
                    </div>
                    {errorMessage && <p className="text-red-400 font-medium bg-red-900/50 p-3 rounded-xl text-center">{errorMessage}</p>}
                    <button type="submit" className={`px-6 py-3 rounded-full font-semibold transition duration-300 shadow-lg w-full sm:w-auto ${themeClasses.buttonAdd} disabled:opacity-50 disabled:cursor-not-allowed`} disabled={!shopInput || selectedTasks.length === 0}> {selectedTasks.length > 1 ? `Agregar ${selectedTasks.length} Tareas` : 'Agregar Tarea'} </button>
                </form>
            );
        };

        const SyncTool = ({ tasks, syncTasksTime, themeClasses }) => {
            const [targetTimeStr, setTargetTimeStr] = useState('');
            const [selectedSyncTaskId, setSelectedSyncTaskId] = useState('');
            const [distributionMode, setDistributionMode] = useState('single'); 
            const totalAppMs = tasks.reduce((acc, t) => acc + (t.running ? t.elapsedTime + (Date.now() - (t.lastTime || Date.now())) : t.elapsedTime), 0);
            const targetMs = parseTimeStringToMs(targetTimeStr);
            let diffMs = targetMs - totalAppMs;
            if (Math.abs(diffMs) < 1000) diffMs = 0;
            const diffSign = diffMs >= 0 ? '+' : '-';
            const diffAbs = Math.abs(diffMs);
            const diffStr = formatTime(diffAbs);
            const isSynced = diffMs === 0 && targetTimeStr !== '';

            useEffect(() => { if (!selectedSyncTaskId && tasks.length > 0) { const running = tasks.find(t => t.running); if (running) setSelectedSyncTaskId(running.id); else setSelectedSyncTaskId(tasks[tasks.length - 1].id); } }, [tasks, selectedSyncTaskId]);
            const handleSync = () => { syncTasksTime(diffMs, distributionMode, selectedSyncTaskId); };

            return (
                <div className={`w-full flex flex-col gap-3`}>
                    <h3 className={`font-bold text-sm text-center uppercase tracking-wide opacity-90 ${themeClasses.primaryText}`}>Sincronizador de Tiempo</h3>
                    <div className="grid grid-cols-2 gap-4 text-sm">
                        <div className="flex flex-col"> <span className={`text-xs opacity-70 ${themeClasses.secondaryText}`}>Total en App:</span> <span className={`font-mono font-bold text-lg ${themeClasses.primaryText}`}>{formatTime(totalAppMs)}</span> </div>
                        <div className="flex flex-col"> <label className={`text-xs opacity-70 ${themeClasses.secondaryText} mb-1`}>Timer Webwork (HH:MM):</label> <input type="text" value={targetTimeStr} onChange={(e) => setTargetTimeStr(e.target.value)} placeholder="ej. 05:30" className={`px-2 py-1 rounded bg-gray-900 border ${themeClasses.inputBorder} ${themeClasses.primaryText} focus:outline-none font-mono`} /> </div>
                    </div>
                    {targetTimeStr && (
                        <div className={`transition-all duration-500 rounded-xl p-3 border-2 mt-2 ${isSynced ? 'bg-green-900/40 border-green-500' : 'bg-red-900/20 border-red-500'}`}>
                            {isSynced ? ( <div className="flex flex-col items-center text-center animate-pulse py-1"> <div className="flex items-center gap-2 mb-1"> <div className="bg-green-500 text-white rounded-full p-1 shadow-lg"> <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg> </div> <span className="text-green-400 font-bold text-lg">Â¡Sincronizado!</span> </div> <p className="text-green-200 text-xs opacity-80">Los tiempos coinciden. Todo listo.</p> </div> ) : ( <> <div className="flex items-center justify-between mb-2"> <span className={`text-xs font-bold ${themeClasses.secondaryText}`}>Diferencia:</span> <span className={`font-mono font-bold ${diffMs >= 0 ? 'text-green-400' : 'text-red-400'}`}> {diffSign}{diffStr} </span> </div> <div className="flex flex-col gap-2"> <div className="flex gap-2"> <button onClick={() => setDistributionMode('single')} className={`flex-1 py-1 text-xs rounded border ${distributionMode === 'single' ? 'bg-blue-600 border-blue-500 text-white' : 'bg-transparent border-gray-600 text-gray-400'}`}>Una Tarea</button> <button onClick={() => setDistributionMode('all')} className={`flex-1 py-1 text-xs rounded border ${distributionMode === 'all' ? 'bg-purple-600 border-purple-500 text-white' : 'bg-transparent border-gray-600 text-gray-400'}`}>Todas</button> </div> {distributionMode === 'single' ? ( <select value={selectedSyncTaskId} onChange={(e) => setSelectedSyncTaskId(e.target.value)} className={`mt-1 px-2 py-2 rounded bg-gray-900 border ${themeClasses.inputBorder} ${themeClasses.secondaryText} focus:outline-none text-sm w-full`}> {tasks.map(t => <option key={t.id} value={t.id}>{t.rawTaskName} [{t.shop}]</option>)} </select> ) : ( <p className="text-[10px] text-center text-gray-400 mt-1 italic">Se repartirÃ¡n {diffSign}{Math.floor(Math.abs(diffMs) / 1000 / 60)} min uniformemente.</p> )} </div> <button onClick={handleSync} className={`mt-2 w-full px-4 py-2 rounded-lg font-bold text-white text-sm transition-colors shadow-md ${diffMs > 0 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-orange-600 hover:bg-orange-700'}`}> {diffMs > 0 ? 'AÃ±adir Tiempo' : 'Restar Tiempo'} </button> </> )}
                        </div>
                    )}
                </div>
            );
        };

        const ReportConfigModal = ({ isOpen, onClose, onGenerate, tasks, syncTasksTime, themeClasses, selectedReportDate, setSelectedReportDate, pastReports = [] }) => {
            if (!isOpen) return null;
            
            const [showOverwriteWarning, setShowOverwriteWarning] = useState(false);
            const handleConfirmClick = () => {
                const reportExists = Array.isArray(pastReports) && pastReports.some(r => r.id === selectedReportDate);
                if (reportExists) { setShowOverwriteWarning(true); } else { onGenerate(); }
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                    <div className={`relative w-full max-w-md p-6 rounded-2xl shadow-2xl ${themeClasses.modalBg || 'bg-gray-800 border-gray-600'} border-2 modal-content max-h-[90vh] overflow-y-auto`}>
                        {showOverwriteWarning ? (
                            <div className="flex flex-col items-center text-center animate-pulse">
                                <div className="bg-red-500/20 p-4 rounded-full mb-3 border-2 border-red-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                                </div>
                                <h3 className="text-xl font-bold text-red-400 mb-2">Â¡Cuidado!</h3>
                                <p className="text-gray-300 mb-6">Ya existe un reporte guardado para el dÃ­a <span className="font-bold text-white">{selectedReportDate}</span>. <br/><br/>Si continuas, se borrarÃ¡ la informaciÃ³n anterior y se reemplazarÃ¡ con los datos actuales.</p>
                                <div className="flex flex-col gap-3 w-full">
                                    <button onClick={onGenerate} className="w-full py-3 rounded-xl font-bold text-white bg-red-600 hover:bg-red-700 transition shadow-lg">SÃ­, Sobreescribir</button>
                                    <button onClick={() => setShowOverwriteWarning(false)} className="w-full py-3 rounded-xl font-bold text-gray-300 bg-gray-700 hover:bg-gray-600 transition">Cancelar</button>
                                </div>
                            </div>
                        ) : (
                            <>
                                <h2 className={`text-xl font-bold mb-4 text-center ${themeClasses.primaryText}`}>Preparar Reporte</h2>
                                <div className="mb-6"> 
                                    <label className={`block text-sm font-semibold mb-2 text-center ${themeClasses.secondaryText}`}>Selecciona Fecha del Reporte:</label> 
                                    <div className="border border-gray-700 rounded-xl overflow-hidden relative"> <CalendarWidget reports={pastReports} selectedDate={selectedReportDate} onSelectDate={setSelectedReportDate} themeClasses={themeClasses} /> </div>
                                    <div className="text-center mt-2 flex justify-center"> <span className={`text-xs font-mono p-1 rounded bg-gray-900 border border-gray-600 ${themeClasses.accentText}`}>Fecha seleccionada: {selectedReportDate}</span> </div>
                                </div>
                                <hr className={`border-t ${themeClasses.inputBorder} mb-6 opacity-50`} />
                                <div className="mb-6"> <SyncTool tasks={tasks} syncTasksTime={syncTasksTime} themeClasses={themeClasses} /> </div>
                                <div className="flex gap-3 mt-4"> 
                                    <button onClick={handleConfirmClick} className={`flex-1 py-3 rounded-full font-bold text-white shadow-lg ${themeClasses.buttonAction}`}> Confirmar y Generar </button> 
                                    <button onClick={onClose} className="px-6 py-3 rounded-full font-bold text-gray-300 bg-gray-700 hover:bg-gray-600 transition-colors"> Cancelar </button> 
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const DeleteAllConfirmationModal = ({ isOpen, onClose, onConfirm, themeClasses }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                     <div className={`relative w-full max-w-sm p-6 rounded-2xl shadow-2xl ${themeClasses.modalBg || 'bg-gray-800 border-gray-600'} border-2 modal-content`}>
                        <div className="flex flex-col items-center text-center animate-pulse">
                            <div className="bg-red-500/20 p-4 rounded-full mb-3 border-2 border-red-500">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </div>
                            <h3 className="text-xl font-bold text-red-400 mb-2">Â¿Empezar DÃ­a Nuevo?</h3>
                            <p className={`${themeClasses.secondaryText || 'text-gray-300'} mb-6 text-sm`}>EstÃ¡s a punto de borrar <strong>todas las tareas</strong> de la lista. <br/><br/> <span className="text-xs opacity-70">AsegÃºrate de haber generado tu E.O.D.R. antes de continuar. Esta acciÃ³n no se puede deshacer.</span></p>
                            <div className="flex flex-col gap-3 w-full">
                                <button onClick={onConfirm} className="w-full py-3 rounded-xl font-bold text-white bg-red-600 hover:bg-red-700 transition shadow-lg">SÃ­, Limpiar Todo</button>
                                <button onClick={onClose} className="w-full py-3 rounded-xl font-bold text-gray-300 bg-gray-700 hover:bg-gray-600 transition">Cancelar</button>
                            </div>
                        </div>
                     </div>
                </div>
            );
        };

        const SalaryCalculatorModal = ({ isOpen, onClose, pastReports, hourlyRate, setHourlyRate, themeClasses }) => {
            if (!isOpen) return null;
            
            const [selectedSalaryDates, setSelectedSalaryDates] = useState([]);
            const toggleDate = (date) => { if (selectedSalaryDates.includes(date)) { setSelectedSalaryDates(prev => prev.filter(d => d !== date)); } else { setSelectedSalaryDates(prev => [...prev, date]); } };

            const handleBatchUpdate = (dates, action) => {
                if (action === 'add') { setSelectedSalaryDates(prev => { const newSet = new Set([...prev, ...dates]); return Array.from(newSet); }); } 
                else if (action === 'remove') { setSelectedSalaryDates(prev => prev.filter(d => !dates.includes(d))); }
            };

            const stats = useMemo(() => {
                let totalHours = 0;
                let daysCount = 0;
                selectedSalaryDates.forEach(date => {
                    const report = pastReports.find(r => r.id === date);
                    if (report) { const hours = parseHoursFromReport(report.content); if (hours > 0) { totalHours += hours; daysCount++; } }
                });
                const totalEarnings = totalHours * (parseFloat(hourlyRate) || 0);
                return { totalHours, daysCount, totalEarnings };
            }, [selectedSalaryDates, pastReports, hourlyRate]);

            const formatToHoursMinutes = (decimalHours) => { let h = Math.floor(decimalHours); let m = Math.round((decimalHours - h) * 60); if (m === 60) { h++; m = 0; } return `${h}h ${m}m`; };
            const decimalToTimeStr = (decimalHours) => { let h = Math.floor(decimalHours); let m = Math.round((decimalHours - h) * 60); if (m === 60) { h++; m = 0; } return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`; };

            const handleExportExcel = () => {
                if (selectedSalaryDates.length === 0) { alert("Selecciona al menos un dÃ­a para exportar."); return; }
                if (typeof XLSX === 'undefined') { alert("Error: La librerÃ­a de Excel no se cargÃ³ correctamente. Verifica tu conexiÃ³n."); return; }
                const rate = parseFloat(hourlyRate) || 0;
                const data = [ ["Fecha", "Tiempo Trabajado", "Tarifa por Hora (USD)", "Total (USD)"] ];
                const sortedDates = [...selectedSalaryDates].sort();
                sortedDates.forEach(date => {
                    const report = pastReports.find(r => r.id === date);
                    let hours = 0;
                    if (report) hours = parseHoursFromReport(report.content);
                    const earning = hours * rate;
                    data.push([ date, decimalToTimeStr(hours), rate, earning ]);
                });
                data.push([]); 
                data.push(["TOTALES", decimalToTimeStr(stats.totalHours), "", stats.totalEarnings]);
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wscols = [ {wch: 15}, {wch: 20}, {wch: 25}, {wch: 20} ];
                ws['!cols'] = wscols;
                XLSX.utils.book_append_sheet(wb, ws, "Reporte Salarial");
                XLSX.writeFile(wb, `Reporte_Salario_${getTodayID()}.xlsx`);
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                    <div className={`relative w-full max-w-lg p-6 rounded-2xl shadow-2xl border-2 modal-content max-h-[90vh] overflow-y-auto ${themeClasses.modalBg}`}>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-emerald-400 to-teal-400 flex items-center gap-2"> <span className="text-3xl">ðŸ’°</span> Calculadora Salarial </h2>
                            <button onClick={onClose} className={`text-gray-400 hover:${themeClasses.primaryText}`}>âœ•</button>
                        </div>
                        <div className={`mb-6 p-4 rounded-xl border ${themeClasses.itemBg} ${themeClasses.inputBorder}`}>
                            <label className={`block text-sm font-semibold mb-2 ${themeClasses.secondaryText}`}>Tu Tarifa por Hora ($):</label>
                            <input type="number" value={hourlyRate} onChange={(e) => setHourlyRate(e.target.value)} className={`w-full px-4 py-3 rounded-lg bg-gray-900 border text-xl font-mono focus:outline-none focus:ring-2 ${themeClasses.inputBorder} ${themeClasses.primaryText}`} placeholder="Ej: 5.50" />
                        </div>
                        <div className="mb-6">
                            <p className={`text-sm mb-2 ${themeClasses.secondaryText}`}>Selecciona los dÃ­as a liquidar:</p>
                            <MultiSelectCalendar reports={pastReports} selectedDates={selectedSalaryDates} onToggleDate={toggleDate} onBatchUpdate={handleBatchUpdate} themeClasses={themeClasses} />
                        </div>
                        <div className="grid grid-cols-2 gap-4 mb-2">
                            <div className={`p-4 rounded-xl border flex flex-col items-center ${themeClasses.itemBg} ${themeClasses.inputBorder}`}>
                                <span className={`text-xs uppercase tracking-wide ${themeClasses.secondaryText}`}>Horas Totales</span>
                                <span className={`text-2xl font-bold mt-1 ${themeClasses.primaryText}`}>{formatToHoursMinutes(stats.totalHours)}</span>
                                <span className={`text-xs opacity-70 ${themeClasses.secondaryText}`}>en {stats.daysCount} dÃ­as</span>
                            </div>
                            <div className="bg-green-900/40 p-4 rounded-xl border border-green-500 flex flex-col items-center justify-center relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-1 opacity-20"><span className="text-4xl">ðŸ’°</span></div>
                                <span className="text-green-300 text-xs uppercase tracking-wide font-bold">Total a Cobrar</span>
                                <span className="text-3xl font-extrabold text-green-400 mt-1">${stats.totalEarnings.toFixed(2)}</span>
                            </div>
                        </div>
                        <div className="mb-4 flex items-start gap-2 p-3 bg-yellow-900/20 border border-yellow-700/50 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-yellow-500 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <p className="text-[11px] text-yellow-200/80 leading-tight"><strong>Nota:</strong> Diferencias de centavos son normales. Ãšsalo para detectar errores grandes de dinero.</p>
                        </div>
                        <button onClick={handleExportExcel} className={`w-full py-3 rounded-xl font-bold text-white shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95 bg-green-700 hover:bg-green-600`}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            Exportar a Excel
                        </button>
                    </div>
                </div>
            );
        };

        const FloatingSalaryButton = ({ onClick }) => {
            const [showBadge, setShowBadge] = useState(true);
            useEffect(() => { const timer = setTimeout(() => setShowBadge(false), 10000); return () => clearTimeout(timer); }, []);
            return (
                <div className="fixed bottom-4 left-4 sm:bottom-6 sm:left-6 z-50 group">
                    {showBadge && ( <div className="absolute -top-3 -right-4 bg-red-600 text-white text-[10px] font-extrabold px-2 py-0.5 rounded-full shadow-lg wiggle-animation z-50 border-2 border-white tracking-widest transition-opacity duration-1000"> Â¡NUEVO! </div> )}
                    <button onClick={onClick} className="relative w-12 h-12 sm:w-16 sm:h-16 rounded-full bg-green-600 hover:bg-green-500 text-white shadow-2xl flex items-center justify-center border-4 border-gray-900 transition-transform duration-300 active:scale-95 hover:scale-110 overflow-hidden" title="Calcular Salario"> <div className="shine-bar"></div> <span className="text-xl sm:text-3xl font-bold relative z-10">$</span> </button>
                </div>
            );
        };
        // #endregion

        // #region MAIN APP LOGIC
        const App = () => {
            const { strategy, message } = useThemeManager(birthdaysList);
            const themeClasses = strategy;

            const { tasks, errorMessage, setErrorMessage, addTask, deleteTask, deleteAllTasks, toggleTimer, updateTaskDetails, sortTasksByShop, resetTaskTimer, stopAllTimers, statusMessage, resumeStoppedTimers, clearStatusMessage, syncTasksTime } = useTasks();
            const [pastReports, setPastReports] = usePersistentState('reports', []);
            const [reportOutput, setReportOutput] = useState('');
            const [calendarSelectedDate, setCalendarSelectedDate] = useState(getTodayID());
            const [isReportModalOpen, setIsReportModalOpen] = useState(false);
            const [selectedReportDate, setSelectedReportDate] = useState(getTodayID());
            const [isSalaryModalOpen, setIsSalaryModalOpen] = useState(false);
            const [hourlyRate, setHourlyRate] = usePersistentState('hourlyRate', '');
            const [isDeleteAllModalOpen, setIsDeleteAllModalOpen] = useState(false);

            useEffect(() => { document.getElementById('root').style.zIndex = '10'; document.body.className = `${themeClasses.bodyBg} transition-colors duration-500`; }, [themeClasses]);
            useEffect(() => { if (statusMessage && statusMessage.taskIdToResume === null) { const timer = setTimeout(() => { clearStatusMessage(); }, 8000); return () => clearTimeout(timer); } }, [statusMessage, clearStatusMessage]);
            
            const handleGenerateReportClick = () => { setIsReportModalOpen(true); };
            const confirmGenerateReport = () => {
                const reportContent = generateEODRContent(tasks, selectedReportDate);
                setReportOutput(reportContent);
                const reportDocId = selectedReportDate;
                const newReport = { id: reportDocId, content: reportContent };
                setPastReports(prev => {
                    const existingIdx = prev.findIndex(r => r.id === reportDocId);
                    if (existingIdx > -1) { const updated = [...prev]; updated[existingIdx] = newReport; return updated; }
                    return [...prev, newReport].sort((a, b) => b.id.localeCompare(a.id));
                });
                setCalendarSelectedDate(reportDocId);
                setIsReportModalOpen(false); 
            };

            const cardGlowClass = themeClasses.name === 'halloween' ? 'glow-card' : (themeClasses.name === 'party' || themeClasses.name === 'biancaBday') ? 'party-glow-card' : '';
            const hasRunningTask = tasks.some(t => t.running);
            const selectedReportContent = useMemo(() => { const found = pastReports.find(r => r.id === calendarSelectedDate); return found ? found.content : null; }, [pastReports, calendarSelectedDate]);

            return (
                <>
                    <GlobalStatusMessage message={statusMessage} resumeAction={resumeStoppedTimers} dismissAction={clearStatusMessage} />
                    <ReportConfigModal isOpen={isReportModalOpen} onClose={() => setIsReportModalOpen(false)} onGenerate={confirmGenerateReport} tasks={tasks} syncTasksTime={syncTasksTime} themeClasses={themeClasses} selectedReportDate={selectedReportDate} setSelectedReportDate={setSelectedReportDate} pastReports={pastReports} />
                    <SalaryCalculatorModal isOpen={isSalaryModalOpen} onClose={() => setIsSalaryModalOpen(false)} pastReports={pastReports} hourlyRate={hourlyRate} setHourlyRate={setHourlyRate} themeClasses={themeClasses} />
                    <DeleteAllConfirmationModal isOpen={isDeleteAllModalOpen} onClose={() => setIsDeleteAllModalOpen(false)} onConfirm={() => { deleteAllTasks(); setIsDeleteAllModalOpen(false); }} themeClasses={themeClasses} />
                    <FloatingSalaryButton onClick={() => setIsSalaryModalOpen(true)} />

                    <div className={`max-w-xl w-11/12 mx-auto rounded-2xl shadow-xl p-8 pt-12 transition-colors duration-500 ${themeClasses.cardBg} max-h-[95vh] overflow-y-auto hide-scrollbar relative ${cardGlowClass}`}>
                        {themeClasses.activeEffects.includes('spiderweb') && <SpiderWeb />}
                        <div className="relative space-y-6"> 
                            <Title themeClasses={themeClasses} celebrationMessage={message} />
                            <TaskInputForm {...{ addTask, errorMessage, setErrorMessage, themeClasses }} />
                            <div className="space-y-4">
                                <hr className={`border-t ${themeClasses.inputBorder}`} />
                                <div className="flex flex-col sm:flex-row justify-between items-center gap-3">
                                    <button type="button" onClick={sortTasksByShop} className="bg-gray-600 text-white px-4 py-2 text-sm rounded-full font-semibold hover:bg-gray-700 transition duration-300 shadow-lg w-full sm:w-auto">Ordenar por Tienda</button>
                                    <button type="button" onClick={() => setIsDeleteAllModalOpen(true)} className="bg-red-800 hover:bg-red-900 text-white px-4 py-2 text-sm rounded-full font-semibold transition duration-300 shadow-lg w-full sm:w-auto flex items-center justify-center gap-2"> <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg> Limpiar Todo </button>
                                    {hasRunningTask && ( <button type="button" onClick={stopAllTimers} className={`bg-purple-700 hover:bg-purple-800 text-white px-4 py-2 text-sm rounded-full font-semibold transition duration-300 shadow-lg w-full sm:w-auto`} title="Detener todos los cronÃ³metros activos">Detener Tareas</button> )}
                                </div>
                                <div className="max-h-[35vh] overflow-y-auto task-scroll pr-2 space-y-3">
                                    {tasks.length > 0 ? tasks.map((task) => ( <TaskListItem key={task.id} task={task} toggleTimer={toggleTimer} deleteTask={deleteTask} updateTaskDetails={updateTaskDetails} themeClasses={themeClasses} resetTaskTimer={resetTaskTimer} celebrationThemeName={themeClasses.name} /> )) : (<p className={`text-center italic ${themeClasses.secondaryText}`}>No hay tareas. Â¡AÃ±ade algunas para empezar!</p>)}
                                </div>
                            </div>
                            <div className="flex flex-col items-center w-full">
                                <button type="button" onClick={handleGenerateReportClick} className={`px-6 py-3 rounded-full font-semibold transition duration-300 shadow-lg mb-4 ${themeClasses.buttonAction}`}>Generar E.O.D.R.</button>
                                <ReportViewer content={reportOutput} themeClasses={themeClasses} placeholder="El reporte aparecerÃ¡ aquÃ­..." />
                            </div>
                            <hr className={`border-t ${themeClasses.inputBorder}`} />
                            <div className="space-y-4">
                                <h2 className={`text-2xl font-bold text-center ${themeClasses.primaryText}`}>Calendario de Reportes</h2>
                                <CalendarWidget reports={pastReports} selectedDate={calendarSelectedDate} onSelectDate={setCalendarSelectedDate} themeClasses={themeClasses} />
                                <h3 className={`font-bold mb-2 ${themeClasses.accentText}`}>Reporte del: {calendarSelectedDate}</h3>
                                <ReportViewer content={selectedReportContent} themeClasses={themeClasses} placeholder="No hay reporte guardado para este dÃ­a." />
                            </div>
                        </div>
                    </div>
                </>
            );
        };
        
        const ThemeWrapper = () => {
            const { strategy } = useThemeManager(birthdaysList);
            return (
                <>
                    {strategy.activeEffects.map(effectKey => {
                        const EffectComponent = EFFECT_COMPONENTS[effectKey];
                        if (effectKey === 'spiderweb') return null; 
                        return EffectComponent ? <EffectComponent key={effectKey} /> : null;
                    })}
                    <App />
                </>
            );
        }
        // #endregion

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ThemeWrapper />);
    </script>
</body>
</html>
